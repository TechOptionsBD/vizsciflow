{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}

{% block title %}Bio-DSL{% endblock %}

{% block head %}
{{ super() }}
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css">

<!-- jQuery Context Menu -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/basic/jquery.qtip.min.css" />

<!-- <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>
<!-- <script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js"></script> -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
<!-- <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script> -->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/2.2.1/knockout-min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
<!-- <script src="http://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='js/ace-builds/src-min-noconflict/ace.js') }}"></script>
<!-- <script src="ace-builds/src-min-noconflict/ext-language_tools.js"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='js/ace-builds/src-min-noconflict/ext-language_tools.js') }}"></script>
<!-- <script src="ace-builds/src-min-noconflict/ext-language_tools.js"></script> -->
<script src="https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.0/d3.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script> -->
<script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
<script src="http://d3js.org/d3-selection-multi.v1.js"></script>

<!-- jQuery Context Menu -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/basic/jquery.qtip.min.js"></script>

<style type="text/css" >

.odd-row {
background-color: LightGray;
}
.even-row {
background-color: White;
}

.panel-actions {
  margin-top: -20px;
  margin-bottom: 0;
  text-align: right;
}
.panel-actions a {
  color:#333;
}
.panel-fullscreen {
    display: block;
    z-index: 9999;
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    overflow: auto;
}

 .marginRow{
     margin:4px !important; 
   }
   
 input[type="text"]{
	background-color:white !important
}

.menu_button {
    color: #666;
    
    cursor: pointer;
}

.menu_button:hover {
    color: #f26d7d;
}

.menu_button:active {
    color: #ccc;
}

.menu_button.selected {
    background-color: #ccc;
}

/* .main-wrapper { */
/*   height: 100vh;   */
/* } */

.row-flex {
  display: flex;
/*   height: 100%; */
}

.col-md-6 {
  flex-grow: 1;
}

.box-one {
/*  background-color: red; */
  max-width: 400px;
/*   min-width: 200px; */
}

.box-two {
/*  background-color: green; */
}

.box-three {
/*  background-color: red; */
  max-width: 400px;
/*   min-width: 200px;   */
}
 
.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

/* .link { stroke: #999; stroke-opacity: .6; stroke-width: 1px; } */

.node circle {
   fill: #ccc;
   stroke: #fff;
   stroke-width: 1.5px;
}

text {
  font: 10px sans-serif;
  pointer-events: none;
}
#scripttab
{
    width:100%;
    height: 600px;
    display:inline-block;
    position:relative;
}
#editor {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
}
    
</style>

{% endblock %}
{% block page_content %}

<div class="container-fluid">
	<div class="row row-flex">
		<div class="col-md-3 box-one" style="padding: 0">
			<div id="dataSourcesPanel" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div>
							<h5 class="col-sm-6">Data Sources</h5>
						</div>
					</div>

					<div class="btn-group">
						<div class="btn-group-sm">
							<!--<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Recursive Reload"
								data-bind="click: load.bind($data, true)">
								<i class="glyphicon glyphicon-unchecked"></i>
							</button> -->
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Reload"
								data-bind="click: load.bind($data, true)">
								<i class="glyphicon glyphicon-refresh"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Download"
								data-bind="click: download">
								<i class="glyphicon glyphicon-download"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="modal"
								data-placement="top" title="Upload"
								data-bind="click: beginFileUpload">
								<i class="glyphicon glyphicon-upload"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="modal"
								data-placement="top" title="Rename"
								data-bind="click: beginRename">
								<i class="glyphicon glyphicon-edit"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Delete" data-bind="click: remove">
								<i class="glyphicon glyphicon-minus"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Add" data-bind="click: addFolder, clickBubble: false">
								<i class="glyphicon glyphicon-plus"></i>
							</button>
						</div>
						<input class="form-control" type="text" placeholder="Search…"
							data-bind="value: searchDataSource, valueUpdate: 'keyup'" />
					</div>
				</div>
				<div class="panel-body draggable-datasources"
					style="height: 416px; overflow-y: scroll; padding: 0">
					<div id="tree" data-bind="treeview: dataSources"></div>
				</div>
			</div>
			<div id="runnableWorkflowsPanel" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div>
							<h5 class="col-sm-6">Job Histories</h5>
						</div>
					</div>
					<div class="btn-group">
						<div class="btn-group-sm">
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Restart Execution"
								data-bind="click: restart">
								<i class="glyphicon glyphicon-repeat"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Stop Execution"
								data-bind="click: stop">
								<i class="glyphicon glyphicon-stop"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Reload" data-bind="click: load">
								<i class="glyphicon glyphicon-refresh"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Deselect All"
								data-bind="click: deselectAll">
								<i class="glyphicon glyphicon-unchecked"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Select All"
								data-bind="click: selectAll">
								<i class="glyphicon glyphicon-check"></i>
							</button>
						</div>
					</div>
				</div>
				<div class="panel-body"
					style="max-height: 200px; width: 100%; overflow-y: scroll;"
					data-bind="foreach: items">
					<div class="row menu_button"
						data-bind="qTipDs:name, event: {dblclick: $parent.copyToEditor}, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"
						style="width: 100%">
						<div style="vertical-align: middle;">
							<input type="checkbox" style="margin-left: 10px;"
								data-bind="checked: selected" /> <img
								style="vertical-align: middle" width="16px" height="16px"
								data-bind="attr:{src: statusImg}" /> <span
								data-bind="text: name" style="width: 100%; margin: 0"></span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6 box-two" id="main">
				<div class="panel panel-primary" id="codeeditor" style="margin: 2px">
				
					<div class="panel-heading text-center">
					<h3 class="panel-title">Bioinformatics Domain Specific Language (Bio-DSL)</h3>
					<div class="btn-group">
						<div class="btn-group-sm">
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Toggle fullscreen" id="panel-fullscreen">
								<i class="glyphicon glyphicon-resize-full"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="About Bio-DSL Syntax" id="panel-about">
								<i class="glyphicon glyphicon-info-sign"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="Save Workflow" id="savewf" onclick="samplesViewModel.beginAdd()">
								<i class="glyphicon glyphicon-floppy-save"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="New Workflow" id="newwf" onclick="samplesViewModel.newwf()">
								<i class="glyphicon glyphicon-asterisk"></i>
							</button>					
						</div>
					</div>
				</div>
					<div class="panel-body" style="">
						<div id="exTabBiowl" class="panel panel-primary" style="min-height: 400px">
							<ul class="nav nav-tabs">
								<li class="active"><a href="#scripttab" data-toggle="tab">Script</a></li>
								<li><a href="#graphtab" data-toggle="tab">Graph</a></li>
							</ul>
						<div class="tab-content ">
							<div class="tab-pane fade in active" id="scripttab">
								<div id="editor" class="editor"></div>
							</div>
							<div class="tab-pane fade" id="graphtab" style="height: 400px">
								<div style="width: 100%; height: 100%" id="graph"></div>
							</div>
						</div>
						</div>
						<br> <span class="text-secondary">Arguments:</span>
						<textarea rows="1" style="width: 100%;" id="args"></textarea>
						<br>
					</div>
				</div>
				<div class="panel panel-primary"
					style="padding: 0px; border: 0; margin: 4px">
					<div class="panel-body" style="padding: 0">
						<button class="btn pull-left btn-primary"
							style="margin-right: 5px;" data-bind="click: runBioWL">Run</button>
						<button class="btn pull-left btn-primary"
							style="margin-right: 5px;" data-bind="click: clearEditor">Clear</button>
						<button class="btn pull-left btn-primary"
							style="margin-right: 5px;" data-bind="click: provenance">Provenance</button>
						<label class="checkbox-inline"><input type="checkbox"
							id="immediate">Immediate</label> <span
							class="badge badge-primary">Time: <span id="duration"
							class="badge badge-light">0s</span>
						</span> <span
							class="glyphicon glyphicon-repeat normal-right-spinner pull-right"
							id="refresh"></span>
					</div>
				</div>
				<div id="exTab2" class="panel panel-primary">
					<ul class="nav nav-tabs">
						<li class="active"><a href="#1" data-toggle="tab">Log</a></li>
						<li><a href="#2" data-toggle="tab">Error</a></li>
						<li><a href="#3" data-toggle="tab">Output</a></li>
					</ul>
					<span class="badge badge-pill badge-primary" style="float: right"
						id="execstatus"></span>
					<!-- 				<span class="badge badge-pill badge-danger" style="float: right" id="execerr"></span> -->
					<div class="tab-content ">
						<div class="tab-pane fade in active" id="1">
							<textarea rows="10" style="min-width: 100%" id="output"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="2">
							<textarea rows="10" style="min-width: 100%" id="error"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="3">
							<span id="executable-status"></span>
							<table class="table table-striped" id="log"
								style="table-layout: fixed; width: 100%">
								<thead>
									<tr>
										<th scope="col" align="center" width="15%">Task</th>
										<th scope="col" align="center" width="70%">Data</th>
										<th scope="col" align="center" width="15%">Status</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</div>
		</div>
		<div class="col-md-3 box-three" style="padding: 2px;">
			<div id="functions" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div class="col-sm-6">
							<h5 class="pull-left">Services</h5>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign"></i>
							</button>
						</div>
					</div>
					<div class="row">
						<div class="btn-group">
							<div class="btn-group">
								<button
									style="float: left; margin-right: 10px; margin-bottom: 10px;"
									class="btn btn-primary dropdown-toggle" type="button"
									id="dropdownMenu2" data-toggle="dropdown" aria-expanded="true">
									<span
										data-bind="text: selectedServiceAccessType() ? selectedServiceAccessType().Name : 'Access Type'"></span>
									<span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu"
									aria-labelledby="dropdownMenu2"
									data-bind="foreach: serviceaccesstypes">
									<li role="presentation"><a role="menuitem" tabindex="-1"
										href="#"
										data-bind="text: Name, click: $parent.selectServiceAccessType"></a></li>
								</ul>
							</div>
							<div class="btn-group">
								<button class="btn btn-primary dropdown-toggle" type="button"
									id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
									<span
										data-bind="text: selectedCategory() ? selectedCategory().Name : 'Level'"></span>
									<span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu"
									aria-labelledby="dropdownMenu1" data-bind="foreach: categories">
									<li role="presentation"><a role="menuitem" tabindex="-1"
										href="#" data-bind="text: Name, click: $parent.selectCategory"></a></li>
								</ul>
							</div>
						</div>
						<div class="input-group">
							<span class="input-group-btn">
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Reload"
									data-bind="click: load">
									<i class="glyphicon glyphicon-refresh"></i>
								</button>
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Add"
									data-bind="click: beginAddLibrary">
									<i class="glyphicon glyphicon-plus"></i>
								</button>
							</span>
							<input class="form-control" type="text" placeholder="Search…"
								data-bind="value: taskFilter, valueUpdate: 'keyup'" />
						</div>
					</div>
				</div>
				<div class="panel-body draggable-functions"
					style="max-height: 500px; overflow-y: scroll; padding: 3px">
					<div class="row" style="width: 100%; margin: 0">
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: left; text-align: center; width: 60%">Name</div>
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: right; padding-left: 4px; text-align: center; width: 40%">Group(Package)</div>
					</div>
					<div data-bind="foreach: filteredTasks">
						<div class="row menu_button"
							data-bind="event: {dblclick: $parent.copyToEditor}, qTip: name, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"
							style="width: 100%; margin: 0">
							<div class="col-md-auto draggable-func"
								style="word-wrap: break-word" data-bind="text: name"></div>
							<div class="col" style="float: right;">
								<span data-bind="text: group" style="text-align: right"></span>(<span
									data-bind="text: package_name" style="text-align: left"></span>)
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 	            <div data-bind="stopBinding: true"> -->
			<div id="samples" class="panel panel-primary" style="padding: 2px">
				<div class="panel-heading">
					<div class="row">
						<div class="col-sm-6">
							<h5 class="pull-left">Workflows</h5>
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="About"	data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign"></i>
							</button>
						</div>
					</div>
					<div class="row">
						<label class="radio-inline"> <input type="radio" name="access" value="0" data-bind="checked: access, click:click" checked="checked" autocomplete="off">Public</label>
						<label class="radio-inline"> <input type="radio" name="access" value="1" data-bind="checked: access, click:click" autocomplete="off">Shared</label>
						<label class="radio-inline"> <input type="radio" name="access" value="2" data-bind="checked: access, click:click" autocomplete="off">Private</label>
						
						<div class="input-group" style="margin-top: 10px">
							<span class="input-group-btn">
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Reload"
									data-bind="click: load">
									<i class="glyphicon glyphicon-refresh"></i>
								</button>
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Save"
									data-bind="click: beginAdd">
									<i class="glyphicon glyphicon-floppy-save"></i>
								</button>
							</span> 
							<input class="form-control" type="text" placeholder="Search…"
								data-bind="value: workflowFilter, valueUpdate: 'keyup'" />
						</div>
					</div>
				</div>
				<div class="panel-body draggable-samples"
					style="max-height: 200px; width: 100%; overflow-y: scroll; padding: 3px">
					<div class="row" style="width: 100%; margin: 0">
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: left; width: 80%; text-align: center">Name</div>
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: right; padding-left: 4px; width: 20%; text-align: center">Owner</div>
					</div>

					<div data-bind="foreach: filteredWorkflows">
						<div class="row menu_button"
							data-bind="event: {dblclick: $parent.copyToEditor}, qTipWf: name, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"
							style="width: 100%; margin: 0">
							<div class="col-xm-6" style="float: left; margin: 0; width: 80%"
								data-bind="text: name"></div>
							<div class="col-xm-3"
								style="float: right; margin: 0; padding-left: 4px; width: 20%"
								data-bind="text: user"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div id="add" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true" style="width: 480px; height: 620px; background: #fff; overflow-y: auto; max-height: calc(100vh - 210px);">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 id="addDialogLabel">Add Library</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <div class="controls">
                 <label class="control-label" for="package">Package</label>
                    <input data-bind="value: name" type="text" id="package" placeholder="{{username}}" style="width: 150px;">
                </div>
                <div class="controls">                    
                	<label class="control-label" for="organization">Organization</label>
                    <input data-bind="value: org" type="text" id="organization" placeholder="Org" style="width: 200px;">
                </div>
            	<div class="controls">
	                <label class="control-label" for="module">Module</label>
                    <input type="file" id="module">
             </div>

				<div id="exTabService" class="controls">
					<ul class="nav nav-tabs">
						<li class="active"><a href="#service1" data-toggle="tab">Script</a></li>
						<li><a href="#service2" data-toggle="tab">JSON Mapper</a></li>
					</ul>
					<div class="tab-content ">
						<div class="tab-pane fade in active" id="service1">
							<textarea rows="10" style="width: 460px;" id="servicescript"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="service2">
							<div style="width: 460px;" id="mapper"></div>
							<br>
						</div>
					</div>
				</div>
                <div class="controls">
                 <label class="control-label" for="pippkgs">pip Install</label>
                 <input data-bind="value: pippkgs" type="text" id="pippkgs" placeholder="" style="width: 200px;">
                </div>
             <div class="controls">
                	<label class="control-label" for="access">Shared</label>
                	<input type="checkbox" id="access" data-bind="checked: access" />
             </div>
        	</div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addLibrary" class="btn btn-primary">Add</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <div><span class="label label-default" id="add-library-info"></span></div>
    </div>
    
</div>
<div id="addSample" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addSampleDialogLabel" aria-hidden="true" style="width: 480px; height: 620px; background: #fff; overflow-y: auto; max-height: calc(100vh - 210px);">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 id="addSampleDialogLabel">Add Workflow</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <div class="controls">
                	<label class="control-label" for="sampleName">Name                 
                    	<input data-bind="value: name" type="text" id="sampleName" placeholder="Name" style="width: 300px;">
                    </label>
                 <label class="control-label" for="sampleDesc">Description                    
                    	<input data-bind="value: desc" type="text" id="sampleDesc" placeholder="Description" style="width: 300px;">
                    </label>
                </div>
                
                <label class="control-label" for="sample">Script:</label>
                <div class="controls">
                    <textarea rows="18" style="width: 540px;" id="sample"></textarea>
                </div>
                </div>
                <div class="btn-group-vertical">
                <label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="align:left" type="radio" name="wfaccess" value="2" data-bind="checked: access" autocomplete="off" checked>Private
				</label>
				<label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="horizonal-align:left"  type="radio" name="wfaccess" value="0" data-bind="checked: access" autocomplete="off">Public
				</label>
				<label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="horizonal-align:left"  type="radio" name="wfaccess" value="1" data-bind="checked: access" autocomplete="off">Shared
    				<input type="text" id="wfusers" placeholder="Users" style="width: 300px;" data-bind="value: users">
				</label>
                  
             </div>
            
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addSample" class="btn btn-primary">Add</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>
    
<div class="modal fade" id="file-upload-dialog" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
           <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal">
                      <span aria-hidden="true">&times;</span>
                      <span class="sr-only">Close</span>
               </button>
               <h4 class="modal-title" id="uploadModalLabel">
                   File Upload
               </h4>
           </div>
           
           <!-- Modal Body -->
            <div class="modal-body">
                <form id="upload-file" class="form-horizontal" role="form" method=POST enctype=multipart/form-data>
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <input type="file" name="file" id="upload" multiple>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                      <button data-bind="click: upload" type="button" class="btn btn-default" id="upload-file-btn" data-dismiss="modal">Upload</button>
                    </div>
                  </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rename-filefolder-dialog" tabindex="-1" role="dialog" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                       <span aria-hidden="true">&times;</span>
                       <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="renameModalLabel">
                    File/Folder Rename
                </h4>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <form id="rename-filefolder" class="form-horizontal" role="form" method=POST enctype=multipart/form-data>
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <input type="text" name="rename-filefolder-text" id="rename-filefolder-text">
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                      <button type="button" class="btn btn-default" id="rename-filefolder-btn" data-dismiss="modal" data-bind="click: rename">Rename</button>
                    </div>
                  </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="edit" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="editDialogLabel" aria-hidden="true" style="background: #fff">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="editDialogLabel">Edit Task</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputTask">Task</label>
                <div class="controls">
                    <input data-bind="value: module" type="text" id="inputTask" placeholder="Module" style="width: 150px;">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputDescription">Name</label>
                <div class="controls">
                    <input data-bind="value: name" type="text" id="inputDescription" placeholder="Name" style="width: 300px;">
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <label class="checkbox">
                        <input type="checkbox"> Done
                    </label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click:editTask" class="btn btn-primary">Update Task</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>
<div id="login" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
    <div class="modal-header">
        <h3 id="loginLabel">Sign In</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputUsername">Username</label>
                <div class="controls">
                    <input data-bind="value: username" type="text" id="inputUsername" placeholder="Username">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputPassword">Password</label>
                <div class="controls">
                    <input data-bind="value: password" type="password" id="inputPassword" placeholder="Password">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: login" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Sign In</button>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script type="text/javascript">
    var refreshId = 0;
    var workflowId = 0;
    var isDirty = false;
    var username = "{{ username }}";

    $(window).on('load', function() {

		$(function(){
		    $.contextMenu({
		        selector: 'li.list-group-item', 
		        callback: function(key, options) {
					
					if (key == "copycode") {
						customBusiness(dataSourceViewModel.selectedNode());
					}
					else if (key == "copyargs") {
						typeInTextarea(document.getElementById("args"), "'" + dataSourceViewModel.selectedNode().path + "'");
					}
		        },
		        items: {
		            "copycode": {name: "Copy to editor", icon: "paste"},
					"sep1": "---------",
		            "copyargs": {name: "Copy to args", icon: "paste"}
		        }
		    });
		});

    	$('#refresh').hide();
        $('.draggable-functions').each(function() {
            // inner scope
            var phrase = $(this);
             
             $(this).find('div.draggable-func').each(function() {
                 // cache jquery object
                 var current = $(this);
                current.addClass("draggable-func");
                 
                 current.draggable({
                     revert : 'invalid',
                     stack : '.draggable-func',
                     helper : 'clone'
                 });
                 
                 
//                  current.on("dragstart", function(e) {
//                 	 e.originalEvent.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
//                  current.bind('dragstart', function(e) {
//                         e.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
             });
         });
        
        $('.draggable-samples').each(function() {
            // inner scope
            var phrase = $(this);
            
            $(this).find('div.draggable-sample').each(function() {
                // cache jquery object
                var current = $(this);
                current.draggable({
                    revert : 'invalid',
                    stack : '.draggable-sample',
                    helper : 'clone'
                });
            });
        });
        
        centerDialog = function(dlg) {
            var windowHeight = $(window).height();
            var windowWidth = $(window).width();
            var boxHeight = dlg.height();
            var boxWidth = dlg.width();
            dlg.css({'margin-left' : ((windowWidth - boxWidth )/2), 'margin-top' : ((windowHeight - boxHeight)/2)});
        }
        
        
        $(document).ready(function() {
            //$('[data-toggle="tooltip"]').tooltip();
            
            $('.menu_button').click(function() {
          		$(this).addClass('selected').siblings().removeClass('selected')
        	});
            
          //Toggle fullscreen
            $("#panel-fullscreen").click(function (e) {
                e.preventDefault();
                
                var $this = $(this);
            
                if ($this.children('i').hasClass('glyphicon-resize-full'))
                {
                    $this.children('i').removeClass('glyphicon-resize-full');
                    $this.children('i').addClass('glyphicon-resize-small');
                }
                else if ($this.children('i').hasClass('glyphicon-resize-small'))
                {
                    $this.children('i').removeClass('glyphicon-resize-small');
                    $this.children('i').addClass('glyphicon-resize-full');
                }
                $(this).closest('.panel').toggleClass('panel-fullscreen');
                editor.resize();
            });
          
            $("#panel-about").click(function (e) {
                e.preventDefault();
   				window.open("static/biodsl-help.html#syntax", '_blank');
            });
        });
        
    });

    var AjaxCalls = function(username, password) {
    	var self = this;
    	self.username = username;
    	self.password = password;
    	
    	self.form = function(uri, method, data, asyncParam = true) {
            var request = {
                    url: uri,
                    type: method,
                    async: asyncParam,
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa(self.username + ":" + self.password));
                    },
                    error: function(jqXHR) {
                        showXHRText(jqXHR);
                    }
                };
                return $.ajax(request);
        }
        
        self.simple = function(uri, method, data, asyncParam = true) {
            var request = {
                    url: uri,
                    type: method,
                    async: asyncParam,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: data,
//                     beforeSend: function (xhr) {
//                         xhr.setRequestHeader("Authorization", 
//                             "Basic " + btoa(self.username + ":" + self.password));
//                     },
                    error: function(jqXHR) {
                        showXHRText(jqXHR);
                    }
                };
                return $.ajax(request);
        }
    }
    
    ajaxcalls = new AjaxCalls('mainulhossain@gmail.com', 'mainul');
    
    $('#tree').bind('mousewheel', function(e) {
    	  $(this).scrollTop($(this).scrollTop() - e.originalEvent.wheelDeltaY);
    	  return false;
    	});
    
    // Create the View Model.
    var DataSourceViewModel = function() {
      var self = this;
      self.init = false;
      self.dataSourcesURI = '/datasources';
      self.dataSources = ko.observableArray();
      self.expandedNodes = [];
      self.searchDataSource = ko.observable();
      self.waittime = 5000; // for throttle

	  function createTree(tree){

	    var options = {
	        bootstrap2: false, 
	        showTags: true,
	        levels: 0,
	        data: tree
	        /*expandIcon: 'fa fa-chevron-right',
	        collapseIcon: 'fa fa-chevron-down',
	        onNodeExpanded: nodeExpand,
	        onNodeCollapsed: nodeCollapse,
	        onNodeSelected: nodeSelect,
	        onNodeUnselected: nodeUnselect*/
	    }
    	$('#treeview').treeview(options);
     };      
      self.findExpandibleNodes = function(text) {
    	var options = {
    		    ignoreCase: true,
    		    exactMatch: false,
    		    revealResults: true,
    		  };
        return $('#tree').treeview('search', [ text, options ]);
      };
    
      self.searchDataSource.subscribe(function () {
    	  var expandibleNodes = self.findExpandibleNodes(self.searchDataSource());
    	  filter = self.searchDataSource().toUpperCase();
    	  div = document.getElementById("tree");
    	  li = div.getElementsByTagName("li");
    	  for (i = 0; i < li.length; i++) {
    	    a = li[i];
    	    if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
    	      li[i].scrollIntoView(false)[0];
    	    }
    	  }
      });
           
      self.beginFileUpload = function() {
          centerDialog($('#file-upload-dialog'));
          $('#file-upload-dialog').modal('show');
      }
      
      self.beginRename= function() {
          centerDialog($('#rename-filefolder-dialog'));
          $('#rename-filefolder-dialog').modal('show');
      }
      
      self.load = function(recursive) {
    	  /*if (self.init) {
	    	  node = self.selectedNode();
	          if (node !== undefined) {
	        	  self.loadItem(node, recursive)
	        	  return;
	          }
    	  }*/

          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'recursive': recursive }).done(function(data) {
        	  self.dataSources(data.datasources);
              ko.cleanNode($("#dataSourcesPanel")[0]);
              ko.applyBindings(self, $("#dataSourcesPanel")[0]);
              //ko.mapping.fromJS($("#dataSourcesPanel")[0], self);
              
              /*$('#tree').find('li.list-group-item').each(function() {
                  // cache jquery object
                  var current = $(this);
                  current.draggable({
                      revert : 'invalid',
                      stack : '.draggable-data',
                      helper : 'clone',
                      zIndex:10000
                  });
              });*/
              
              for (node in self.expandedNodes) {
              	$('#tree').treeview('expandNode', [ parseInt(self.expandedNodes[node]), { levels: 0, silent: true } ]);
              }
                        
          }).fail(function(jqXHR) {
              showXHRText(jqXHR);
          });
      }
      
      self.getItemByPath = function(source, path) {
    	  if (source.path === path)
    		  return source;
    	  
    	  if (source.nodes !== undefined || source.nodes != null) {
	    	  for(var i =0; i < source.nodes.length; ++i){
	    		  
	    		  var subNode = self.getItemByPath(source.nodes[i], path);
	    		  if (subNode)
	    			  return subNode;
	    	  }
    	  }
    		
    	  return null;	
      }
      
      self.loadItem = function(node, recursive = true) {
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'load': node.path, 'recursive': recursive }).done(function(data) {
              
              var dataSources = self.dataSources();
              
              for(var i=0; i < dataSources.length; ++i){
            	  
            	  var item = self.getItemByPath(dataSources[i], data.path);
            	  if (item != null) {
                  	item.text = data.text;
                  	item.nodes = data.nodes;
                    item.loaded = data.loaded;
                    
                    ko.cleanNode($("#dataSourcesPanel")[0]);
                    ko.applyBindings(self, $("#dataSourcesPanel")[0]);
                    
                    for (node in self.expandedNodes)
                        $('#tree').treeview('expandNode', [ parseInt(self.expandedNodes[node]), { levels: 0, silent: true } ]);
                        
                  	break;
            	  }
              }
          }).fail(function(jqXHR) {
              showXHRText(jqXHR);
          });
      }
      
      self.selectedNode = function()
      {
    	  nodes = $('#tree').treeview('getSelected')
          if (nodes !== undefined && nodes.length > 0)
        	    return nodes[0];
      }
      self.parentNode = function(node)
      {
    	  return $('#tree').treeview('getParent', node.nodeId);
      }
      
      self.upload = function() {

     	  $('#file-upload-dialog').modal('hide');
     	 
          var files = $("#upload").get(0).files;
          var formdata = new FormData();
          formdata.append('upload', files[0]); //use get('files')[0]
          node = self.selectedNode();
          if (node === undefined)
        	  return;
          formdata.append('path', node.path);//you can append it to formdata with a proper parameter name

          ajaxcalls.form(self.dataSourcesURI, 'POST', formdata).done(function(data) {
        	  self.loadItem(node);
          });
       }
      
	  self.about = function() {

		  window.open("static/biodsl-help.html#datasources", '_blank');
      }
      
      self.download = $.debounce(500, function() {
    	  
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          $.redirect(self.dataSourcesURI, { 'download': node.path }, "POST", "_blank");
      });
            
      self.addFolder = $.debounce(500, function() {
      	  console.log("add folder");
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'addfolder': node.path }).done(function(data) {
        	  self.loadItem(node);
        	  $('#tree').treeview('selectNode', node.nodeId);
          });
      });
      
      self.remove = $.debounce(500, function() {
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'delete': node.path }).done(function(data) {
          	  var parentNode = self.parentNode(node);
          	  if (parentNode === undefined)
          	  	return;
          	  
          	  var siblings = $('#tree').treeview('getSiblings', node.nodeId);
          	  if (siblings !== undefined && siblings.length > 0)
          	  	sibling = siblings[0].path;
        	  self.loadItem(parentNode);
        	  
        	  if (sibling === undefined)
        	  	$('#tree').treeview('selectNode', node.nodeId);
        	  else {
        	  	siblingNode = self.getItemByPath(parentNode, sibling);
        	  	$('#tree').treeview('selectNode', siblingNode.nodeId);
        	  }
          });
      });
      
      self.rename = function() {
    	  $('#rename-filefolder-dialog').modal('hide');
    	  
          node = self.selectedNode();
          if (node === undefined)
              return;
          
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'oldpath': node.path, 'rename': $('#rename-filefolder-text').val() }).done(function(data) {
        	  self.loadItem(self.parentNode(node));
          });
      }
      
      self.load(true);
      self.init = true;
    }
   
   // Last trigger node Id
   var lastSelectedNodeId = null;
   // Last time trigger 
   var lastSelectTime = null;
   
   // Custom business method 
   function customBusiness(data){
       var pos = editor.selection.getCursor();             
       editor.session.insert(pos,  "'" + data.path + "'");
       editor.focus();
   }

function typeInTextarea(el, newText) {
  var start = el.selectionStart;
  var end = el.selectionEnd;
  var text = el.value;

  var before = "";
  var after = "";
  if (text != null) {
	if (start != null)
		before =  text.substring(0, start);
	else
		start = text.length;
		
	if (end != null)
		after = text.substring(end, text.length);
  }
  else
	start = 0;
  
  el.value = (before + newText + after)
  el.selectionStart = el.selectionEnd = start + newText.length
  el.focus()
}

   function clickNode(event, data) {
    if (lastSelectedNodeId && lastSelectTime) {
     var time = new Date().getTime();
     var t = time - lastSelectTime;
     if (lastSelectedNodeId == data.nodeId && t < 600) {
      customBusiness(data);
     }
    }
    lastSelectedNodeId = data.nodeId;
    lastSelectTime = new Date().getTime();
   }
    
   function serviceHelpRef(href) {
	   if (href) {
		   return "<a href='static/" + href + "' target='_blank'>" + "More...</a>";
	   }
	   else {
		   return "";
	   }
   }
	ko.bindingHandlers.qTip = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
// 	            content: {
// 					title: viewModel.name(),
// 					text: "<p>" + viewModel.desc() + "  " + serviceHelpRef(viewModel.href()) + "</p><p>" + viewModel.example() +  "</p><p>Double click to insert into code editor.</p>"
// 				},
				content: {
	                text: function(event, api) {
	                    $.ajax({
	                        url: "/functions?tooltip&name=" + viewModel.name() + "&package=" + viewModel.package_name()
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        if (!content) {
	                        	content = "";
	                        }
	                        else {
		                        content = JSON.parse(content);
		                        content = "<p>Name: " + content.name + (content.package_name && content.package_name.length ? "<br>Package: " + content.package_name : "") + "<br>Access: " + content.access + "</p>"
		                        +"<p>Example: " + content.example + (content.example2.length ? "<br>Example2: " + content.example2 : '') + (content.returns.length ? "<br>Returns: " + content.returns : '') + "</p>"
		                        +"<p>Desc: " + content.desc + (content.href && content.href.length ? "<br>" + serviceHelpRef(content.href) : "") + "</p>"
		                        + "<p>Double click to insert into code editor</p>";
	                        }
	                        api.set('content.text', content);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	        
	                    return 'Loading...'; // Set some initial text
	                }
	            },
				show: {
					delay: 500
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left'
	            }
	        });
	        //ko.applyBindingAccessorsToNode(element, {visible: valueAccessor()});
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        /*var visible = ko.utils.unwrapObservable(valueAccessor());
	        if(!visible) {
	            $(element).qtip('hide');
	        }*/
	    }
	};
	
	ko.bindingHandlers.qTipWf = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
// 	            content: {
// 					title: viewModel.name(),
// 					text: "<p>" + viewModel.desc() + "</p><p>Double click to insert into code editor.</p>"
// 				},
				content: {
	                text: function(event, api) {
	                    $.ajax({
	                        url: "/samples?tooltip=" + viewModel.id()
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        if (!content) {
	                        	content = "";
	                        }
	                        else {
		                        content = JSON.parse(content);
		                        content = "<p>Name: " + content.name + "<br>Owner: " + content.user + "<br>Public: " + content.public + "</p>"
		                        +"<p>Desc: " + content.desc + "</p>"
		                        + "<p>Double click to insert into code editor</p>";
	                        }
	                        api.set('content.text', content);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	        
	                    return 'Loading...'; // Set some initial text
	                }
	            },
				show: {
					delay: 500
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left'
	            }
	        });
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	    }
	};

	ko.bindingHandlers.qTipDs = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
				content: {
	                text: function(event, api) {
	                    $.ajax({
	                        url: "/runnables?tooltip=" + viewModel.id() //api.elements.target.attr('href') // Use href attribute as URL
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        content = JSON.parse(content);
	                        content = "<p>Name: " + content.name + "</p><p>Created: " + content.created_on + "<br>Modified: " + content.modified_on + "<br>Duration: " + content.duration + 
	                        	"(s)</p><p>Status: " + content.status + (content.err && content.err.length > 0 ? "<br>Error: " + content.err : "") + "</p><p>Double click to show in report.<br>Check to pin job to report.</p>";

	                        api.set('content.text', content);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	        
	                    return 'Loading...'; // Set some initial text
	                }
	            },
				show: {
					delay: 500
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left'
	            }
	        });
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	    }
	};
    ko.bindingHandlers.treeview = {
       init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
           $(element).treeview({data: ko.toJS(valueAccessor())})
           .on('nodeSelected', function(event, data) {
           		clickNode(event, data);
           }).on('nodeUnselected', function(event, data) {
           		clickNode(event, data);
   		   }).on('nodeExpanded', function(event, data) {
   			
   			dataSourceViewModel.expandedNodes.push(data.nodeId);
   			if (data.loaded === undefined || !data.loaded) {
   				dataSourceViewModel.loadItem(data)
   			}
   		}).on('nodeCollapsed', function(event, data) {
   			
   			var index = dataSourceViewModel.expandedNodes.indexOf(data.nodeId);
   		    if (index > -1) 
   		    	dataSourceViewModel.expandedNodes.splice(index, 1);
   		});
       },
       update: function(element, valueAccessor, allBindings) {
       }
   };
    
    // Create the View Model and initialise with initial data 
    var dataSourceViewModel = new DataSourceViewModel();
    ko.applyBindings(dataSourceViewModel, $("#dataSourcesPanel")[0]);
    
    ko.applyBindings(dataSourceViewModel, $("#file-upload-dialog")[0]);
    ko.applyBindings(dataSourceViewModel, $("#rename-filefolder-dialog")[0]);

    $('#rename-filefolder-dialog').on('shown.bs.modal', function () {
    	var node = dataSourceViewModel.selectedNode();
    	if (node === undefined)
    		return;
    	var filename = node.path.replace(/^.*[\\\/]/, '')
        $('#rename-filefolder-text').val(filename);
        $('#rename-filefolder-text').focus();
    });
    
    // configure ace.js for code editor
    var langTools = ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.renderer.setShowGutter(false);
    editor.getSession().setMode("ace/mode/python");
    editor.setOptions({
    	highlightSelectedWord: true, 
    	enableBasicAutocompletion: true,
    	autoScrollEditorIntoView: true,
    	fontSize: "11pt"
    });
    editor.renderer.setOptions({
    	showGutter: true, 
    	displayIndentGuides: true
    });
    //editor.setKeyboardHandler("ace/keyboard/vim");
    //editor.setTheme("ace/theme/idle_fingers");
    //editor.setTheme("ace/theme/twilight");
    editor.setTheme("ace/theme/iplastic");
    editor.setShowPrintMargin(false);
    editor.on("input", function() {
        isDirty = !editor.session.getUndoManager().isClean();
    });
    
    /*var staticWordCompleter = {
   	    getCompletions: function(editor, session, pos, prefix, callback) {
   	        var wordList = ["foo", "bar", "baz"];
   	        callback(null, wordList.map(function(word) {
   	            return {
   	                caption: word,
   	                value: word,
   	                meta: "static"
   	            };
   	        }));

   	    }
   	}*/

   	
   	if (localStorage[username.concat('_inputVals')] !== undefined)
   		editor.session.setValue(JSON.parse(localStorage[username.concat('_inputVals')]));

    var dynamicWordCompleter = {
     	getCompletions: function(editor, session, pos, prefix, callback) {
 	    $.getJSON('/functions?codecompletion=' + prefix,
 	      function(tagList) {
 	        callback(null, tagList.functions.map(function(qtag) {
 	          return { caption: qtag.name + '(' + qtag.package_name + ')', value: qtag.example, meta: qtag.group}
 	      }));
 	    })
 	   }
  	}
    
   	langTools.setCompleters([dynamicWordCompleter])
   	// or 
   	//editor.completers = [staticWordCompleter]
    
//     editor.droppable({

//         activeClass: "ui-state-default",
//         hoverClass: "ui-state-hover",
//         accept: ":not(.ui-sortable-helper)",
        
//         drop: function(event, ui) {
//           var pos = editor.renderer.screenToTextCoordinates(event.clientX, event.clientY)
//           var v = ko.dataFor(ui.draggable[0]);
//           example = ''
//           if (v)
//         	  if (v.example)
//         		  example = v.example();
//         	  else if (v.sample)
//         		  example = v.sample();
//               else {
//             	  node = $('#tree').treeview('getNode', $(ui.draggable[0]).data('nodeid'));
//             	  if (node){
//             		  example = node.path;
// //             		  path = split(node.path, ';');
// //             		  if (path.length >= 2)
// //             			  example = node[]
//             	  }
//             	  else
//             		  example = v.name() + "()";
//               }
//           editor.session.insert(pos, example);
//           editor.focus();
//           return true;
//         }
//       });

    
    
    jsonArray2Table = function(table, jsonArr) {
    	$.each(jsonArr, function (index, value) {
            /* $.each(value, function (key, val) {
                TableRow += "<td>" + val + "</td>";
            }) */;
            
            var row = $('<tr></tr>');
            var cell = $("<td>" + value['name'] + "</td>")
           		.css('overflow', 'hidden')
           		.css('word-wrap', 'break-word');
            row.append(cell);
            
        	cell = $('<td></td>');
			data = value['data'];
        	if (!Array.isArray(data)) {
    			data = [data];
			}
			var added = false;
        	$.each(data, function (key, val) {		
	            var link =  $('<a />', {
	                'href': 'javascript:void(0)',
	                'text': val
	            }).on('click', function() {
					if ((parseInt(value['datatype']) & 0x02) != 0 || (parseInt(value['datatype']) & 0x400) != 0) {
		           		$.redirect('/datasources', { 'download': val }, "POST", "_blank");
					}
					else {
						var w = window.open();
						$(w.document.body).text(val);
					}
	            });
	            
				if (added)
					cell.append('; ');
					
	            cell.append(link);
				added = true;
        	});
            row.append(cell);
            
            cell = "<td>" + value['status'] + "</td>";
            row.append(cell);
            table.append(row);
        });
    }
    
    function activateTab(tab){
        $('.nav-tabs a[href="#' + tab + '"]').tab('show');
      };
     
     function showXHRText(jqXHR) {
     	if (jqXHR.responseJSON !== undefined && jqXHR.responseJSON.err !== undefined) {
     		$("#error").val(jqXHR.responseJSON.err);
     	}
     	else {
     		$("#error").val(jqXHR.statusText);
     	}
     	activateTab(2);
     }
     
     function TasksViewModel() {
         var self = this;
         self.tasksURI = '/functions';
         self.graphsURI = '/graphs';
         self.username = "";
         self.password = "";
         self.tasks = ko.observableArray();
         self.taskFilter = ko.observable("");
		 this.filteredTasks = ko.computed(function(){
			 return this.tasks().filter(function(task){
				 if(!self.taskFilter() || task.name().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1
	       		   || task.package_name().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1
	       		   || task.group().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1)
	            return task;
	      	});
		 },this);

         self.serviceaccesstypes = ko.observableArray([
         	{
         		Id: 0,
         		Name: "Public"
         	}, 
         	{
       	  		Id: 1,
       	  		Name: "Shared"
       	  	}, 
         	{
       	  		Id: 2,
       	  		Name: "Private"
       	  	}]);
         
         self.selectedServiceAccessType = ko.observable({
     	  	Id: 0,
   	  		Name: "Public"
   		});
         
         self.categories = ko.observableArray([{
         	  Id: 0,
         	  Name: "Basic"
         	}, {
         	  Id: 1,
         	  Name: "Advanced"
         	}]);
         
         self.selectedCategory = ko.observable({
       	  Id: 0,
     	  Name: "Basic"
     	});

         self.selectCategory = function(category) {
             self.selectedCategory(category);
           }
         
         self.selectServiceAccessType = function(serviceAccessType) {
             self.selectedServiceAccessType(serviceAccessType);
             self.load();
           }
         
        	self.click = function(model){
        		self.login();
        	    return true;
         }
         
        	self.clearResults = function() {
        		$("#output").val("");
	             $("#error").val("");
	             $("#log tbody").empty();
	             $("#duration").text("0s");
	             $("#execstatus").text("");
        	}
         self.clearEditor = function() {
             editor.session.setValue("");
             self.clearResults();
         }

         self.updateTask = function(task, newTask) {
             var i = self.tasks.indexOf(task);
             self.tasks()[i].package_name(newTask.package_name);
             self.tasks()[i].name(newTask.name);
             self.tasks()[i].internal(newTask.internal);
             self.tasks()[i].example(newTask.example);
             self.tasks()[i].example2(newTask.example2);
             self.tasks()[i].desc(newTask.desc);
             self.tasks()[i].runmode(newTask.runmode);
             self.tasks()[i].group(newTask.group);
             self.tasks()[i].href(newTask.href);
         }
         
         self.beginAddLibrary = function() {
			$.getJSON('/functions?demoserviceadd', function(demoservice) {
				/*demoservice = JSON.parse(demoservice)
             	if ($.isEmptyObject(demoservice))
             		return;*/

				addLibraryViewModel.getCodeEditor().setValue(demoservice.demoservice.script, 1);
				addLibraryViewModel.getMapperEditor().setValue(demoservice.demoservice.mapper, 1);
	         	centerDialog($('#add'));
    	         $('#add').modal('show');
 	    	})
         }
         
         self.about = function() {
        	 window.open("static/biodsl-help.html#services", '_blank');
         }
         
         self.updateWorkflow = function() {
             var script = $.trim(editor.getSession().getValue());
             if (!script && !workflowId) // || editor.session.getUndoManager().isClean())
           	 	return; // if script empty and workflowId not set, it means (empty) workflow is not set yet.
           	
           	var formdata = new FormData();
             
             formdata.append('workflowId', parseInt(workflowId));
             formdata.append('script', script);
             
             ajaxcalls.form(self.tasksURI, 'POST', formdata, false).done(function(data) {
             	if (!$.isEmptyObject(data)) {
             		workflowId = parseInt(data['workflowId']);
             		editor.session.getUndoManager().markClean();
             	}
             });
         }
         
         self.runBioWL = function(task) {
           self.updateWorkflow();
           if (!workflowId) {
               $("#error").val("Workflow is not updated. Change the code and run again.");
               return;
           }
           
           var script = $.trim(editor.getSession().getValue());
           if (!script)
         	  return;
           
           $('#refresh').show();
           var formdata = new FormData();
           
           formdata.append('workflowId', parseInt(workflowId));
           formdata.append('args', $('#args').val());
           formdata.append('immediate', $('#immediate').prop('checked'));
           self.clearResults();
           ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
         	  $('#refresh').hide();
             	
             	if (data === undefined)
             		return;
             	data = JSON.parse(data)
             	if ($.isEmptyObject(data))
             		return;
             	
             	if (data['err'] && data['status'] !== 'SUCCESS')
                 	activateTab(2);
                 else {
                 	if (!$.isEmptyObject(data['log']))
                 		activateTab(3);
                 	else
                 		activateTab(1);
                 }
             	
                 $("#output").val(data['out']);
                 $("#error").val(data['err']);
                 $("#log tbody").empty();
                 jsonArray2Table($("#log"), data['log']);
                 $("#duration").text(data['duration'] + 's');
                 $("#execstatus").text(data['status']);
                 runnablesViewModel.load();                    
             }).fail(function(jqXHR, textStatus) {
             	$('#refresh').hide();
             	showXHRText(jqXHR);
             });
         }
         
         self.buildGraph = function(task) {
         	self.updateWorkflow();
             if (!$.trim(editor.getSession().getValue()))
           	  return;
             
             var formdata = new FormData();
             
             formdata.append('workflowId', parseInt(workflowId));
             ajaxcalls.form(self.graphsURI, 'POST', formdata).done(function(data) {
               	
               	if (data === undefined)
               		return;
               	data = JSON.parse(data);
               	if ($.isEmptyObject(data))
               		return;
               	
    			d3graph.show(data);
               	
              }).fail(function(jqXHR, textStatus) {
              	$('#refresh').hide();
              	showXHRText(jqXHR);
             });
         }
         
         self.provenance = function() {
         	$.redirect(self.tasksURI, { 'provenance': true }, "POST", "_blank");
        	}
         
         self.generatePythonCode = function(task) {
         	$('#refresh').show();
         	var formdata = new FormData();
             formdata.append('code', editor.getSession().getValue());
             formdata.append('args', $('#args').val());
             formdata.append('immediate', $('#immediate').prop('checked'));
             ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
                 $('#refresh').hide();
                 if (data === undefined)
                     return;
                 
                 data = JSON.parse(data)
                 
                 $("#output").val(data.out);
                 $("#error").val(data.err);
                 $("#log tbody").empty();
                 jsonArray2Table($("#log"), data['log']);
                 $("#execstatus").text(data['status']);
                 $("#duration").text(data.duration + 's');
             });
         }
         self.beginEditLibrary = function(task) {
            // editTaskViewModel.setTask(task);
             $('#edit').modal('show');
         }
         self.edit = function(task, data) {
           ajaxcalls.simple(task.uri(), 'PUT', data).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         self.remove = function(task) {
           ajaxcalls.simple(task.uri(), 'DELETE').done(function() {
                 self.tasks.remove(task);
             });
         }
         self.markInProgress = function(task) {
           ajaxcalls.simple(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         self.markDone = function(task) {
           ajaxcalls.simple(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         self.beginLogin = function() {
             $('#login').modal('show');
         }
         self.login = function() {
         	self.load();
         }
         self.load = $.debounce(500, function() {
           ajaxcalls.simple(self.tasksURI, 'GET', {'level': 1, 'access': self.selectedServiceAccessType().Id}).done(function(data) {
         	  self.tasks([]);
         	  $.each(data.functions, function(i, f) {
         		  self.tasks.push({
                       package_name: ko.observable(f.package_name),
                       name: ko.observable(f.name),
                       //internal: ko.observable(f.internal),
                       example: ko.observable(f.example),
                       example2: ko.observable(f.example2),
                       desc: ko.observable(f.desc),
                       //runmode: ko.observable(f.runmode),
                       group: ko.observable(f.group),
                       href: ko.observable(f.href)
                   });
         	  });
             }).fail(function(jqXHR) {
                 showXHRText(jqXHR);
             });
         });
         
         //self.beginLogin();
         
         self.copyToEditor = function(item) {
            var pos = editor.selection.getCursor();             
            editor.session.insert(pos, self.selectedCategory().Id == 0 ? item.example() + "\r\n": item.example2() + "\r\n");
            editor.focus();
        }
     }
        
       function SamplesViewModel(sampleViewModel) {
           var self = this;
           self.samplesURI = '/samples';
           self.items = ko.observableArray();
           self.sampleViewModel = sampleViewModel;
           self.access = ko.observable("0");
           self.workflowFilter = ko.observable("");
			this.filteredWorkflows = ko.computed(function(){
		       return this.items().filter(function(item){
		           if(!self.workflowFilter() || item.name().toLowerCase().indexOf(self.workflowFilter().toLowerCase()) !== -1)
		             return item;
		       });
  			},this);
			
		  self.about = function() {
	    	  
			  window.open("static/biodsl-help.html#workflows", '_blank');
	      }

           self.remove = function() {
        	   
        	   var item = self.firstSelectedItem();
               if (item == null)
                   return;
               
               ajaxcalls.simple(self.samplesURI, 'POST', { 'delete': item.name }).done(function(data) {
                   self.load();
               });
           }
           
           self.newwf = function() {
        	   workflowId = 0;
        	   editor.session.setValue("");
           }
           
           self.beginAdd = function() {
               script = editor.getSession().getValue();
               if (script.length > 0)
               {
                   self.sampleViewModel.getCodeEditor().setValue(script, 1);
               }
               centerDialog($('#addSample'));
               $('#addSample').modal('show');
           }
           
           self.firstSelectedItem = function() {
               var items = self.items();
               for (var i = 0; i < items.length; i++) {
                   if (items[i].selected()){
                       return items[i];
                   }
               }
               return null;
           }
           
           self.copyToEditor = function(item) {
        	   
        	   ajaxcalls.simple(self.samplesURI, 'GET', {'sample_id': item.id}).done(function(data) {
        		   
               	   if ($.isEmptyObject(data))
               		   return;
        		   
        		   var pos = editor.selection.getCursor();        	   
                   editor.session.insert(pos, data['script']);//.join('\r\n'));
                   editor.focus();
                   workflowId = item.id();
            	   
               }).fail(function(jqXHR) {
                   showXHRText(jqXHR);
               });
           }
           
           self.click = function(model){
          		self.load();
          	    return true;
           }
           
           self.load = function() {
               ajaxcalls.simple(self.samplesURI, 'GET', {'access': self.access()}).done(function(data) {
            	   self.items([]);
            	   $.each(data.samples, function(i, s){
            		   self.items.push({
            			   id: ko.observable(s.id),
            			   user:ko.observable(s.user),
                           name: ko.observable(s.name),
                           selected: ko.observable(false)
                       });
            	   });
            	   
               }).fail(function(jqXHR) {
                   showXHRText(jqXHR);
               });
           }
       }
       
       $('input[name="wfaccess"]').change(function(e) { // Select the radio input group

    	    // This returns the value of the checked radio button
    	    // which triggered the event.
    	    if ($(this).val() == 1) {
    	    	$("#wfusers").show();
    	    }
    	    else {
    	    	$("#wfusers").hide();
    	    }
    	});
       
       $("input[name='loadr']").change(function(e) { // Select the radio input group
	   	    if (this.checked) {
	   	    	
	   	    }
	   	    else {
	   	    	
	   	    }
   		});
       
	function CreateAceEditor(editorId, mode, height) {
	            // configure ace.js for code editor
            var mapperArea = $(editorId);
            
            var mapperDiv = $('<div>', {
                position: 'absolute',
                id: 'aceeditor',
                width: mapperArea.width(),
                height: height,//mapperArea.height(),
                'class': mapperArea.attr('class'),
                'css': 'border:2px solid black'
            }).insertBefore(mapperArea);
                
            mapperArea.css('visibility', 'hidden');
            var offset = mapperDiv.offset();
            mapperArea.attr('rows', 1);
            
            var mapperEditor = ace.edit(mapperDiv[0]);
            mapperEditor.renderer.setShowGutter(false);
            mapperEditor.getSession().setValue(mapperArea.val());
            mapperEditor.getSession().setMode(mode);
            mapperEditor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
            mapperEditor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
            //editor.setKeyboardHandler("ace/keyboard/vim");
            //editor.setTheme("ace/theme/idle_fingers");
            //editor.setTheme("ace/theme/twilight");
            mapperEditor.setTheme("ace/theme/iplastic");
//             editor.setOptions({       
//                 fontSize: "12pt"
//               });

return mapperEditor;
}
        function SampleViewModel() {
            var self = this;
            self.samplesURI = '/samples';
            
            self.name = ko.observable();
            self.desc = ko.observable();
            self.access = ko.observable("2");
            self.users = ko.observable();

			self.sampleEditor = CreateAceEditor("#sample", "ace/mode/python", 300);
 
            self.addSample = function(task) {
                $('#addSample').modal('hide');
                
                var formdata = new FormData();
                formdata.append('sample', self.sampleEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
                
                if (self.name() === undefined)
                	return;
                formdata.append('name', self.name());
                
                if (self.desc() !== undefined)
                	formdata.append('desc', self.desc());
                
                if (self.access() !== undefined) {
                	formdata.append('access', self.access());
                
	                if (self.access() == 1) {
	                	formdata.append('users', self.users());
	                }
                }

                ajaxcalls.form(self.samplesURI, 'POST', formdata).done(function(data) {
                	samplesViewModel.load();
                });
            }
            
            self.getCodeEditor = function() { return self.sampleEditor; }
        }
        
        function isJson(item) {
            item = typeof item !== "string" ? JSON.stringify(item) : item;

            try {
                item = JSON.parse(item);
            } catch (e) {
                return false;
            }

            return (typeof item === "object" && item !== null);
        }
        
        function AddLibraryViewModel() {
            var self = this;
            self.tasksURI = '/functions';
            
            self.name = ko.observable("{{username}}");
            self.org = ko.observable();
            self.access = ko.observable();
            self.pippkgs = ko.observable();
 			
			self.mapperEditor = CreateAceEditor("#mapper", "ace/mode/json", 200);
			self.codeEditor = CreateAceEditor("#servicescript", "ace/mode/python", 200);
			
			self.checkFunction = function() {
				var formdata = new FormData();
				
				var json = self.mapperEditor.getSession().getValue();
				if (!isJson(json)) {
					$("#add-library-info").text("Not a valid JSON mapper.");
					return false;
				}
				
				var mapper = JSON.parse(json);
				if (!mapper || !mapper.functions || !mapper.functions.length) {
					$("#add-library-info").text("No valid service is defined for mapping in JSON.");
					return false;
				}
				mapper = mapper.functions[0];
				var func = (mapper.name && mapper.name.length ? mapper.name : mapper.internal);
				if (!func || !func.length) {
					$("#add-library-info").text("No valid service name is given.");
					return false;
				}
				
				var package_name = (self.name() && self.name().length ? self.name() : "");
				
				var success = false;
				ajaxcalls.simple(self.tasksURI, 'GET', { 'check_function': '', 'package':  package_name, 'name': func}, false).done(function(data) {
            		
					if (data === undefined) {
						$("#add-library-info").text("Can't retrieve service information. Check your internet connection.");
						return;
					}
					
					success = data['check_funtion'] == 'False';
					if (!success)
						$("#add-library-info").text("The service already exists. Please change the package name or service name.");
				});
				
				return success;
			}
			
            self.addLibrary = function(task) {
            	
            	if (!self.checkFunction()) {            		
            		return;
            	}
            	
            	$("#add-library-info").text("");
            	$('#add').modal('hide');
            	
            	var files = $("#module").get(0).files;
            	var formdata = new FormData();
            	formdata.append('library', files[0]); //use get('files')[0]
            	formdata.append('mapper', self.mapperEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
				formdata.append('script', self.codeEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
            	
            	if (self.name() !== undefined)
            		formdata.append('package', self.name());
            	if (self.org() !== undefined)
            		formdata.append('org', self.org());
            	if (self.access() !== undefined)
            		formdata.append('access', self.access());
            	if (self.pippkgs() !== undefined)
            		formdata.append('pippkgs', self.pippkgs());

                ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
                                   	
                    $("#output").val(data.out);
                    $("#error").val(data.err);
                    $("#log tbody").empty();
                    
                    if (tasksViewModel !== undefined) {
                    	tasksViewModel.load();
                    }
                    if (data.err.length != 0) {
                    	$("#execstatus").text("Service cannot be added.");
                    	activateTab(2);
                    }
                    else {
                    	activateTab(1);
                    }
                });
            }
            
            self.getMapperEditor = function() { return self.mapperEditor; }
			self.getCodeEditor = function() { return self.codeEditor; }
        }
        
        function EditTaskViewModel() {
            var self = this;
            self.package_name = ko.observable();
            self.name = ko.observable();
            self.internal = ko.observable();
            self.example = ko.observable();
            self.example2 = ko.observable();
 
            self.setTask = function(task) {
                self.task = task;
                self.package_name(task.package_name());
                self.name(task.name());
                self.internal(task.internal());
                self.example(task.example());
                self.example2(task.example2());
                $('edit').modal('show');
            }
 
            self.editTask = function() {
                $('#edit').modal('hide');
                tasksViewModel.edit(self.task, {
                	package_name: self.package_name(),
                	name: self.name(),
                    internal: self.internal(),
                    example: self.example(),
                    example2: self.example2()
                });
            }
        }
        
        function LoginViewModel() {
            var self = this;
            self.username = ko.observable();
            self.password = ko.observable();
//             tasksViewModel.login('mainulhossain@gmail.com', 'mainul');
//             tasksViewModel.loadSamples()
            
            self.login = function() {
                $('#login').modal('hide');
                tasksViewModel.login(self.username(), self.password());
            }
        }
        
        function RunnablesViewModel(sampleViewModel) {
            var self = this;
            self.runnablesURI = '/runnables';
            self.items = ko.observableArray();
        	self.historyLoading = false;
        	
			self.loadHistory = function(id, switchTab = false) {
            	
				ajaxcalls.simple(self.runnablesURI, 'GET', { 'id':  id}).done(function(data) {
            		
					if (data === undefined)
						return;
	            	
					if (switchTab) {
		            	if (data['err'] && data['status'] !== 'SUCCESS'){
	                    	activateTab(2);
		            	}
	                    else {
	                    	if (!$.isEmptyObject(data['log']))
	                    		activateTab(3);
	                    	else
	                    		activateTab(1);
	                    }
					}
	            	
					$("#output").val(data['out']);
	            	$("#error").val(data['err']);
	            	$("#log tbody").empty();
	            	jsonArray2Table($("#log"), data['log']);
	            	$("#duration").html(data['duration'] + 's');
	            	$("#execstatus").text(data['status']);
            	}).fail(function(jqXHR, textStatus) {
                	$('#refresh').hide();
                	showXHRText(jqXHR);
                });
            }
            
			self.about = function() {
				window.open("static/biodsl-help.html#jobs", '_blank');
		    }
			
            self.copyToEditor = function(item) {
            	self.loadHistory(item.id(), true);
            }
            
            self.selectedIds = function() {
            	var ids = [];
                var items = self.items();
                for (var i = 0; i < items.length; i++) {
                    if (items[i].selected()){
                        ids.push(items[i].id());
                    }
                }
                return ids;
            }
            
            self.stop = function(){
            	
                ids = self.selectedIds();
                if (ids.length == 0)
                	return;
                
            	ajaxcalls.simple(self.runnablesURI, 'GET', { 'stop':  ids.join()}).done(function(data) {
            		
            	});
            }
            
			self.restart = function(){
            	
                ids = self.selectedIds();
                if (ids.length == 0)
                	return;
                
            	ajaxcalls.simple(self.runnablesURI, 'GET', { 'restart':  ids.join()}).done(function(data) {
            		
            	});
            }
			
			self.changeSelection = function(state){
				$.each(self.items(), function(index, item){
					item.selected(state);
				});
			}
			
			self.selectAll = function(){
            	self.changeSelection(true);
            }
			
			self.deselectAll = function(){
				self.changeSelection(false);
            }
            
            self.statusIcon = function(status){
            	if (status == "STARTED")
            		return "{{ url_for('static', filename='spinner.gif') }}";
            	else if (status == "PENDING")
            		return "{{ url_for('static', filename='spinner.gif') }}";
            	else if (status == "RECEIVED")
            		return "{{ url_for('static', filename='spinner.gif') }}";
            	else if (status == "FAILURE")
                	return "{{ url_for('static', filename='cancel.gif') }}";
            	else
            		return "{{ url_for('static', filename='completed.gif') }}";
            }
            
            self.load = function() {
            	if (self.historyLoading)
            		return;
            	
            	self.historyLoading = true;
                ajaxcalls.simple(self.runnablesURI, 'GET').done(function(data) {
                	if (data == undefined)
                		return;
                	
                	var selectedIds = self.selectedIds();
                    self.items([]);
                    $.each(data['runnables'], function(i, s){
                        self.items.push({
                        	id: ko.observable(s.id),
                            name: ko.observable(s.name),
                            status: ko.observable(s.status),
                            statusImg: ko.observable(self.statusIcon(s.status)),
                            selected: ko.observable($.inArray(s.id, selectedIds) !== -1)
                        });
                    });
                }).fail(function(jqXHR) {
                    showXHRText(jqXHR);
                }).always(function(x, textStatus, jqXHR){
                	self.historyLoading = false;
                });
            }
        }
        
        var addLibraryViewModel = new AddLibraryViewModel();
        var sampleViewModel = new SampleViewModel();
        var editTaskViewModel = new EditTaskViewModel();
        var loginViewModel = new LoginViewModel();
        var tasksViewModel = new TasksViewModel();
        tasksViewModel.login();
        
        var samplesViewModel = new SamplesViewModel(sampleViewModel);
        samplesViewModel.load();
        
        var runnablesViewModel = new RunnablesViewModel();        
        runnablesViewModel.load();
        
        ko.applyBindings(tasksViewModel, $('#main')[0]);
        ko.applyBindings(tasksViewModel, $('#functions')[0]);
        ko.applyBindings(samplesViewModel, $('#samples')[0]);
        ko.applyBindings(addLibraryViewModel, $('#add')[0]);
        ko.applyBindings(sampleViewModel, $('#addSample')[0]);
        ko.applyBindings(editTaskViewModel, $('#edit')[0]);
        ko.applyBindings(loginViewModel, $('#login')[0]);
        
        ko.applyBindings(runnablesViewModel, $('#runnableWorkflowsPanel')[0]);
    
    function D3Graph()
    {
    	var self = this;
   		self.width = 960;
   		self.height = 500;
   		self.colors = d3.scaleOrdinal(d3.schemeCategory10);

		self.show = function(rels) {
			self.nodes = [];
			self.links = [];
			
			rels.forEach(function(rel){
				var exists = self.nodes.filter(function(n)
					{
						return rel.source.id === n.id; 
					});
				if (exists.length == 0)
					self.nodes.push(rel.source);
				
				exists = self.nodes.filter(function(n)
					{
						return rel.target.id === n.id; 
					});
				if (exists.length == 0)
					self.nodes.push(rel.target);
			});
			
			rels.forEach(function(rel) { 
			    var sourceNode = self.nodes.filter(function(n) { return n.id === rel.source.id; })[0];
			    var targetNode = self.nodes.filter(function(n) { return n.id === rel.target.id; })[0];
			    self.links.push({source: sourceNode, target: targetNode, value: rel.type});
			});
			
// 			// Compute the distinct nodes from the links.
// 	   		self.links.forEach(function(link) {
// 	   		  link.source = self.nodes[link.source] || (self.nodes[link.source] = link.source);
// 	   		  link.target = self.nodes[link.target] || (self.nodes[link.target] = link.target);
// 	   		});
			
			self.width = $("#graph").width();
			self.height = $("#graph").height();
			
// 			var force = d3.layout.force()
// 	   		    .nodes(d3.values(self.nodes))
// 	   		    .links(self.links)
// 	   		    .size([self.width, self.height])
// 	   		    .linkDistance(60)
// 	   		    .charge(-300)
// 	   		    .friction(0.9)
// 	   		    .on("tick", self.tick)
// 	   		    .start();
			
			if (self.svg !== undefined && self.svg != null) {
				d3.select("svg")
					.selectAll("*")
					.remove();
				d3.select("svg").remove();
			}
			
			self.svg = d3.select("#graph").append("svg")
   		    	.attr("width", self.width)
   		    	.attr("height", self.height);
			
			self.svg.append('defs').append('marker')
		        .attrs({'id':'arrowhead',
		            'viewBox':'-0 -5 10 10',
		            'refX':13,
		            'refY':0,
		            'orient':'auto',
		            'markerWidth':13,
		            'markerHeight':13,
		            'xoverflow':'visible'})
		        .append('svg:path')
		        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
		        .attr('fill', '#999')
		        .style('stroke','none');
			
			self.simulation = d3.forceSimulation()
		        .force("link", d3.forceLink().id(function (d) {return d.id;}).distance(100).strength(1))
		        .force("charge", d3.forceManyBody())
		        .force("center", d3.forceCenter(self.width / 2, self.height / 2));
			
			self.link = self.svg.selectAll(".link")
            .data(self.links)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr('marker-end','url(#arrowhead)');
				
	        self.link.append("title")
	            .text(function (d) {return d.type;});
        	
			self.edgepaths = self.svg.selectAll(".edgepath")
	            .data(self.links)
	            .enter()
	            .append('path')
	            .attrs({
	                'class': 'edgepath',
	                'fill-opacity': 0,
	                'stroke-opacity': 0,
	                'id': function (d, i) {return 'edgepath' + i}
	            })
            	.style("pointer-events", "none");

        	self.edgelabels = self.svg.selectAll(".edgelabel")
	            .data(self.links)
	            .enter()
	            .append('text')
	            .style("pointer-events", "none")
	            .attrs({
	                'class': 'edgelabel',
	                'id': function (d, i) {return 'edgelabel' + i},
	                'font-size': 10,
	                'fill': '#aaa'
	            });

	        self.edgelabels.append('textPath')
	            .attr('xlink:href', function (d, i) {return '#edgepath' + i})
	            .style("text-anchor", "middle")
	            .style("pointer-events", "none")
	            .attr("startOffset", "50%")
	            .text(function (d) {return d.value});
	        
	       self.node = self.svg.selectAll(".node")
		        .data(self.nodes)
		        .enter()
		        .append("g")
		        .attr("class", "node")
		   	    .on("mouseover", self.mouseover)
			    .on("mouseout", self.mouseout)
		        .call(d3.drag()
		                .on("start", self.dragstarted)
		                .on("drag", self.dragged)
		                //.on("end", self.dragended)
		        );

		    self.node.append("circle")
		        .attr("r", 5)
		        .style("fill", function (d, i) {return self.colors(i);})
		
		    self.node.append("title")
		        .text(function (d) {return d.id;});
		
		    self.node.append("text")
		        .attr("dy", -3)
		        .text(function (d) {return d.name+":"+d.label;});

		    self.simulation
   				.nodes(self.nodes)
            	.on("tick", self.tick);

	        self.simulation.force("link")
	            .links(self.links);
		}
   		
   		self.tick = function() {
   			self.link
            .attr("x1", function (d) {return d.source.x;})
            .attr("y1", function (d) {return d.source.y;})
            .attr("x2", function (d) {return d.target.x;})
            .attr("y2", function (d) {return d.target.y;});

        	self.node.attr("transform", function (d) {return "translate(" + d.x + ", " + d.y + ")";});

	        self.edgepaths.attr('d', function (d) {
	            return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
	        });

	        self.edgelabels.attr('transform', function (d) {
	            if (d.target.x < d.source.x) {
	                /* var bbox = this.getBBox();
	                rx = bbox.x + bbox.width / 2;
	                ry = bbox.y + bbox.height / 2; */
	                rx=0;
	                ry=0;
	                return 'rotate(180 ' + rx + ' ' + ry + ')';
	            }
	            else {
	                return 'rotate(0)';
	            }
	        });
  	  	}

   		self.mouseover = function() {
   		  d3.select(this).select("circle").transition()
   		      .duration(750)
   		      .attr("r", 16);
   		}

   		self.mouseout = function() {
   		  d3.select(this).select("circle").transition()
   		      .duration(750)
   		      .attr("r", 8);
   		}
   		
   		self.dragstarted = function(d) {
   	        if (!d3.event.active)
   	        	self.simulation.alphaTarget(0.3).restart()
   	        d.fx = d.x;
   	        d.fy = d.y;
   	    }

   	    self.dragged = function(d) {
   	        d.fx = d3.event.x;
   	        d.fy = d3.event.y;
   	    }
    }
    
    d3graph = new D3Graph();
    
    $(window).on('unload', function() {
        if (refreshId != 0)
            clearInterval(refreshId);
    });
        
	$(window).on("blur focus", function(e) {
	    var prevType = $(this).data("prevType");
	
	    if (prevType != e.type) {   //  reduce double fire issues
	        switch (e.type) {
	            case "blur":
	            	clearInterval(refreshId);
	            	refreshId = 0;
	                break;
	            case "focus":
	            	if (!refreshId) {
	            		refreshId = setInterval(function() {
	            			if (runnablesViewModel !== undefined)
	            				runnablesViewModel.load();
	           				ids = runnablesViewModel.selectedIds();
	                        if (ids.length == 1) {
	                        	runnablesViewModel.loadHistory(ids[0], false);
	            			}
	                    }, 10000); //  refresh the executables once in 10 seconds
	            	}
	                break;
	        }
	    }
	
	    $(this).data("prevType", e.type);
	})
	
	$(window).on('beforeunload', function(){
		var script = $.trim(editor.getSession().getValue());
    	localStorage.setItem(username.concat('_inputVals'), JSON.stringify(script) );
	});
	
	$(window).on('keypress', function(event){
		if(event.keyCode=='27'){
          $("#add").modal('hide');
		  $("#addSample").modal('hide');
      }
	});
	
	$(exTabBiowl).on('shown.bs.tab', function (e) {
		var x = $(e.target).text();
		if (x === "Graph") {
			tasksViewModel.buildGraph();
		}
	})
        
</script>
{{ pagedown.include_pagedown() }}
{% endblock %}
