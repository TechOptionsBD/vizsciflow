{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}

{% block title %}Bio-DSL{% endblock %}

{% block head %}
{{ super() }}
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.8/themes/default/style.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/basic/jquery.qtip.min.css" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round|Open+Sans">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.8/jstree.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ace-builds/src-min-noconflict/ace.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ace-builds/src-min-noconflict/ext-language_tools.js') }}"></script>
<script src="https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js"></script>
<script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
<script src="http://d3js.org/d3-selection-multi.v1.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/basic/jquery.qtip.min.js"></script>

<script type="text/javascript" src="{{ url_for('static', filename='js/util.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ko.observableDictionary.js') }}"></script>
<!-- <script type='text/javascript' src="https://raw.github.com/jamesfoster/knockout.observableDictionary/master/ko.observableDictionary.js"></script> -->

<link rel="stylesheet" href="{{ url_for('static', filename='biowl.css') }}" />
{% endblock %}
{% block page_content %}

<div class="container-fluid">
	<div class="row row-flex">
		<div class="col-md-3 box-one" style="padding: 0">
			<div id="dataSourcesPanel" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div>
							<h4 class="col-sm-6">Data Sources</h4>
						</div>
					</div>

					<div class="btn-group">
						<div class="btn-group-sm">
							<!--<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Recursive Reload"
								data-bind="click: load.bind($data, true)">
								<i class="glyphicon glyphicon-unchecked"></i>
							</button> -->
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Reload"
								data-bind="click: load.bind($data, true)">
								<i class="glyphicon glyphicon-refresh toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Download"
								data-bind="click: download">
								<i class="glyphicon glyphicon-download toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="modal"
								data-placement="top" title="Upload"
								data-bind="click: beginFileUpload">
								<i class="glyphicon glyphicon-upload toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="modal"
								data-placement="top" title="Update Metadata"
								data-bind="click: beginUpdateMetadata">
								<i class="glyphicon glyphicon-edit toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Delete Folder/File" data-bind="click: remove">
								<i class="glyphicon glyphicon-minus toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Add Folder" data-bind="click: addFolder, clickBubble: false">
								<i class="glyphicon glyphicon-plus toolbar-icon"></i>
							</button>
						</div>
						<input class="form-control" type="text" placeholder="Search…"
							data-bind="value: searchDataSource, valueUpdate: 'keyup'" />
					</div>
				</div>
				<div class="panel-body draggable-datasources"
					style="height: 416px; overflow-y: scroll; padding: 0">
					<div id="tree" data-bind="jstree: { data: dataSources }"></div>
				</div>
			</div>
			<div id="runnableWorkflowsPanel" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div>
							<h4 class="col-sm-6">Job Histories</h4>
						</div>
					</div>
					<div class="btn-group">
						<div class="btn-group-sm">
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Restart Execution"
								data-bind="click: restart">
								<i class="glyphicon glyphicon-repeat toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Stop Execution"
								data-bind="click: stop">
								<i class="glyphicon glyphicon-stop toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Reload" data-bind="click: load">
								<i class="glyphicon glyphicon-refresh toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Deselect All"
								data-bind="click: deselectAll">
								<i class="glyphicon glyphicon-unchecked toolbar-icon"></i>
							</button>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="Select All"
								data-bind="click: selectAll">
								<i class="glyphicon glyphicon-check toolbar-icon"></i>
							</button>
						</div>
					</div>
				</div>
				<div class="panel-body"
					style="max-height: 200px; width: 100%; overflow-y: scroll;"
					data-bind="foreach: items">
					<div class="row menu_button"
						data-bind="event: {dblclick: $parent.copyToEditor}, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }, style: { color: recent() ? 'red' : 'black' }"
						style="width: 100%">
						<div class="col-md-auto" style="vertical-align: middle;" data-bind="event: {click: $parent.toggleExpand}">
							<input type="checkbox" style="margin-left: 10px;"
								data-bind="checked: selected" /> <img
								style="vertical-align: middle" width="16px" height="16px"
								data-bind="attr:{src: statusImg}" /> <span
								data-bind="text: name" style="width: 100%; margin: 0"></span>
						</div>
						
						<div class="col" style="float: right;">
							<span data-bind="text: modified" style="text-align: right"></span>
						</div>
						<div style="clear: both" ></div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6 box-two" id="main">
				<div class="panel panel-primary" id="codeeditor" style="margin: 2px">
				
					<div class="panel-heading text-center">
					<h4 style="margin-bottom:10px">Bioinformatics Domain Specific Language (Bio-DSL)</h4>
					
					<div class="btn-group">
						<div class="btn-group-sm">
							<button class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="New Workflow" id="newwf" onclick="samplesViewModel.newwf()">
								<i class="glyphicon glyphicon-asterisk toolbar-icon"></i>
							</button>
							<button class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="Save Workflow" id="savewf" data-bind="click: updateWorkflow.bind(true)">
								<i class="glyphicon glyphicon-floppy-disk toolbar-icon"></i>
							</button>
							<button class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="Save As Workflow..." id="saveaswf" onclick="samplesViewModel.beginAdd()">
								<i class="glyphicon glyphicon-floppy-save toolbar-icon"></i>
							</button>
							
							<div class="btn-group" role="group">
							    <button id="btnGroupDrop1" type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							      <span class="glyphicon glyphicon-text-size toolbar-icon" aria-hidden="true"></span>
					                <span class="caret"></span>
					                <span class="sr-only">Text size</span>
							    </button>
							    <ul class="dropdown-menu" role="menu" aria-labelledby="btnGroupDrop1" id="panel-fontsize">
							      <li><a class="dropdown-item" href="#">10</a></li>
							      <li><a class="dropdown-item" href="#">11</a></li>
							      <li><a class="dropdown-item" href="#">12</a></li>
							      <li><a class="dropdown-item" href="#">14</a></li>
							      <li><a class="dropdown-item" href="#">16</a></li>
							      <li><a class="dropdown-item" href="#">18</a></li>
							      <li><a class="dropdown-item" href="#">20</a></li>
							      <li><a class="dropdown-item" href="#">24</a></li>							      
							    </ul>
							</div>
							<button class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="About Bio-DSL Syntax" id="panel-about">
								<i class="glyphicon glyphicon-info-sign toolbar-icon"></i>
							</button>
							
  							<button class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="Toggle fullscreen" id="panel-fullscreen">
								<i class="glyphicon glyphicon-resize-full toolbar-icon"></i>
							</button>
						</div>
						<h5 id='script-name'></h5>
					</div>
					
				</div>
					<div class="panel-body" style="">
						<div id="exTabBiowl" class="panel panel-primary" style="min-height: 400px">
							<ul class="nav nav-tabs marginBottom">
								<li class="active "><a href="#scripttab" class="backgroundRed" data-toggle="tab">Script</a></li>
								<li><a href="#graphtab" data-toggle="tab">Graph</a></li>
								<li><a href="#metatab" data-toggle="tab">Metadata</a></li>
<!-- 								<li><a href="#graphtab" data-toggle="tab"><button class="close closeTab" type="button" >×</button>Graph</a></li> -->
<!-- 								<li><a href="#metatab" data-toggle="tab"><button class="close closeTab" type="button" >×</button>Metadata</a></li> -->
							</ul>
						<div class="tab-content">
							<div class="tab-pane fade in active scriptstyle" id="scripttab">
								<div id="editor" class="editorstyle"></div>
							</div>
							<div class="tab-pane fade" id="graphtab" style="height: 400px">
								<div style="width: 100%; height: 100%" id="graph"></div>
							</div>
							<div class="tab-pane fade in scriptstyle" style="overflow-y: scroll" id="metatab">
							</div>
						</div>
						</div>
						<br> <span class="text-secondary">Arguments:</span>
						<textarea rows="1" style="width: 100%;" id="args"></textarea>
						<br>
					</div>
				</div>
				<div class="panel panel-primary"
					style="padding: 0px; border: 0; margin: 4px">
					<div class="panel-body" style="padding: 0">
						<button class="btn pull-left btn-primary btn-lg"
							style="margin-right: 5px;" data-bind="click: runBioWL">Run</button>
						<button class="btn pull-left btn-primary btn-lg"
							style="margin-right: 5px;" data-bind="click: clearResults">Clear</button>
						<!-- <button class="btn pull-left btn-primary"
							style="margin-right: 5px;" data-bind="click: provenance">Provenance</button> -->
						<label class="checkbox-inline"><input type="checkbox"
							id="immediate">Immediate</label> <span
							class="badge badge-primary">Time: <span id="duration"
							class="badge badge-light">0s</span>
						</span> <span
							class="glyphicon glyphicon-repeat normal-right-spinner pull-right"
							id="refresh"></span>
					</div>
				</div>
				<div id="exTab2" class="panel panel-primary">
					<ul class="nav nav-tabs">
						<li class="active"><a href="#1" data-toggle="tab">Log</a></li>
						<li><a href="#2" data-toggle="tab">Error</a></li>
						<li><a href="#3" data-toggle="tab">Output</a></li>
					</ul>
					<span class="badge badge-pill badge-primary" style="float: left" id="reportid"></span>
					<span class="badge badge-pill badge-primary" style="float: right" id="execstatus"></span>
					<!-- 				<span class="badge badge-pill badge-danger" style="float: right" id="execerr"></span> -->
					<div class="tab-content ">
						<div class="tab-pane fade in active" id="1">
							<textarea rows="10" style="min-width: 100%" id="output"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="2">
							<textarea rows="10" style="min-width: 100%" id="error"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="3">
							<span id="executable-status"></span>
							<table class="table table-striped" id="log"
								style="table-layout: fixed; width: 100%">
								<thead>
									<tr>
										<th class="report-header" scope="col" align="center" width="15%">Task</th>
										<th class="report-header" scope="col" align="center" width="70%" style="text-align:center;">Data</th>
										<th class="report-header" scope="col" align="center" width="15%" style="text-align:center;">Status</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</div>
		</div>
		<div class="col-md-3 box-three" style="padding: 2px;">
			<div id="functions" class="panel panel-primary">
				<div class="panel-heading">
					<div class="row">
						<div class="col-sm-6">
							<h4 class="pull-left">Services</h4>
							<button class="btn btn-primary pull-right" data-toggle="tooltip"
								data-placement="top" title="About"
								data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign toolbar-icon"></i>
							</button>
						</div>
					</div>
					<div class="row">
						<div class="btn-group">
							<div class="btn-group">
								<button
									style="float: left; margin-right: 10px; margin-bottom: 10px;"
									class="btn btn-primary dropdown-toggle" type="button"
									id="dropdownMenu2" data-toggle="dropdown" aria-expanded="true">
									<span
										data-bind="text: selectedServiceAccessType() ? selectedServiceAccessType().Name : 'Access Type'" style="font-size:20px;"></span>
									<span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu"
									aria-labelledby="dropdownMenu2"
									data-bind="foreach: serviceaccesstypes">
									<li role="presentation"><a role="menuitem" tabindex="-1"
										href="#"
										data-bind="text: Name, click: $parent.selectServiceAccessType"></a></li>
								</ul>
							</div>
							<div class="btn-group">
								<button class="btn btn-primary dropdown-toggle" type="button"
									id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
									<span
										data-bind="text: selectedCategory() ? selectedCategory().Name : 'Level'" style="font-size:20px;"></span>
									<span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu"
									aria-labelledby="dropdownMenu1" data-bind="foreach: categories">
									<li role="presentation"><a role="menuitem" tabindex="-1"
										href="#" data-bind="text: Name, click: $parent.selectCategory"></a></li>
								</ul>
							</div>
						</div>
						<div class="input-group">
							<span class="input-group-btn">
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Reload"
									data-bind="click: reload">
									<i class="glyphicon glyphicon-refresh toolbar-icon"></i>
								</button>
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Add"
									data-bind="click: beginAddLibrary">
									<i class="glyphicon glyphicon-plus toolbar-icon"></i>
								</button>
							</span>
							<input class="form-control" type="text" placeholder="Search…"
								data-bind="value: taskFilter, valueUpdate: 'keyup'" />
						</div>
					</div>
				</div>
				<div class="panel-body draggable-functions"
					style="max-height: 500px; overflow-y: scroll; padding: 3px">
					<div class="row" style="width: 100%; margin: 0">
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: left; text-align: center; width: 60%">Name</div>
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: right; padding-left: 4px; text-align: center; width: 40%">Group(Package)</div>
					</div>
					<div data-bind="foreach: filteredTasks">
						<div class="row"
							data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"
							style="width: 100%; margin: 0">
							<div class="col-md-auto draggable-func menu_button float: left;" style="word-wrap: break-word" data-bind="text: name, event: {dblclick: $parent.copyToEditorDblClick, click: $parent.toggleExpand}, clickBubble: false"></div>
							<div class="col" style="float: right;">
								<span data-bind="text: group" style="text-align: right"></span>(<span data-bind="text: package_name" style="text-align: left"></span>)
							</div>
							<div style="clear:both"></div>
						</div>
					</div>
				</div>
			</div>
			<!-- 	            <div data-bind="stopBinding: true"> -->
			<div id="samples" class="panel panel-primary" style="padding: 2px">
				<div class="panel-heading">
					<div class="row">
						<div class="col-sm-6">
							<h4 class="pull-left">Workflows</h4>
							<button class="btn btn-primary pull-right" data-toggle="tooltip" data-placement="top" title="About"	data-bind="click: about">
								<i class="glyphicon glyphicon-info-sign toolbar-icon"></i>
							</button>
						</div>
					</div>
					<div class="row">
						<label class="radio-inline"> <input type="radio" name="access" value="0" data-bind="checked: access, click:click" checked="checked" autocomplete="off">Public</label>
						<label class="radio-inline"> <input type="radio" name="access" value="1" data-bind="checked: access, click:click" autocomplete="off">Shared</label>
						<label class="radio-inline"> <input type="radio" name="access" value="2" data-bind="checked: access, click:click" autocomplete="off">Private</label>
						
						<div class="input-group" style="margin-top: 10px">
							<span class="input-group-btn">
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Reload"
									data-bind="click: load">
									<i class="glyphicon glyphicon-refresh toolbar-icon"></i>
								</button>
								<button style="margin-right: 10px;" class="btn btn-primary"
									data-toggle="tooltip" data-placement="top" title="Save"
									data-bind="click: beginAdd">
									<i class="glyphicon glyphicon-floppy-save toolbar-icon"></i>
								</button>
							</span> 
							<input class="form-control" type="text" placeholder="Search…"
								data-bind="value: workflowFilter, valueUpdate: 'keyup'" />
						</div>
					</div>
				</div>
				<div class="panel-body draggable-samples"
					style="max-height: 200px; width: 100%; overflow-y: scroll; padding: 3px">
					<div class="row" style="width: 100%; margin: 0">
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: left; width: 80%; text-align: center">Name</div>
						<div class="p-3 mb-2 bg-primary text-white"
							style="float: right; padding-left: 4px; width: 20%; text-align: center">Owner</div>
					</div>

					<div data-bind="foreach: filteredWorkflows">
						<div class="row menu_button"
							data-bind="event: {dblclick: $parent.copyToEditor}, qTipWf: name, css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"
							style="width: 100%; margin: 0">
							<div class="col-xm-6" style="float: left; margin: 0; width: 80%"
								data-bind="text: name"></div>
							<div class="col-xm-3"
								style="float: right; margin: 0; padding-left: 4px; width: 20%"
								data-bind="text: user"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div id="add" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true" style="width: 560px; height: 640px; background: #fff; overflow-y: auto; max-height: calc(100vh - 210px);">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 id="addDialogLabel">Add Service</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <div class="controls">
                 <label class="control-label" for="package">Package</label>
                    <input data-bind="value: name" type="text" id="package" placeholder="{{username}}" style="width: 150px;">
                </div>
                <div class="controls">                    
                	<label class="control-label" for="organization">Organization</label>
                    <input data-bind="value: org" type="text" id="organization" placeholder="Org" style="width: 200px;">
                </div>
            	<div class="controls">
	                <label class="control-label" for="module">Module</label><input type="file" id="module">
             	</div>

				<div id="exTabService" class="controls">
					<ul class="nav nav-tabs">
						<li class="active"><a href="#service1" data-toggle="tab">Script</a></li>
						<li><a href="#service2" data-toggle="tab">JSON Mapper</a></li>
					</ul>
					<div class="tab-content ">
						<div class="tab-pane fade in active" id="service1">
							<textarea rows="10" style="width: 540px;" id="servicescript"></textarea>
							<br>
						</div>
						<div class="tab-pane fade" id="service2">
							<div style="width: 540px;" id="mapper"></div>
							<br>
						</div>
					</div>
				</div>
                <div class="controls">
                 <label class="control-label" for="pippkgs">pip Install</label>
                 <input data-bind="value: pippkgs" type="text" id="pippkgs" placeholder="" style="width: 200px;">
                </div>
             <div class="controls">
                	<label class="control-label" for="access">Shared</label>
                	<input type="checkbox" id="access" data-bind="checked: access" />
             </div>
        	</div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addLibrary" class="btn btn-primary">Add</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <div><span class="label label-default" id="add-library-info"></span></div>
    </div>
    
</div>
<div id="addSample" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="addSampleDialogLabel" aria-hidden="true" style="width: 580px; height: 700px; background: #fff; overflow-y: auto; max-height: calc(100vh - 210px);">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 id="addSampleDialogLabel">Add Workflow</h4>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <div class="controls">
                	<label class="control-label" for="sampleName">Name                 
                    	<input data-bind="value: name" type="text" id="sampleName" placeholder="Name" style="width: 300px;">
                    </label>
                 <label class="control-label" for="sampleDesc">Description                    
                    	<input data-bind="value: desc" type="text" id="sampleDesc" placeholder="Description" style="width: 300px;">
                    </label>
                </div>
                
                <label class="control-label" for="sample">Script:</label>
                <div class="controls">
                    <textarea rows="18" style="width: 540px;" id="sample"></textarea>
                </div>
                </div>
                <div class="btn-group-vertical">
                <label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="align:left" type="radio" name="wfaccess" value="2" data-bind="checked: access" autocomplete="off" checked>Private
				</label>
				<label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="horizonal-align:left"  type="radio" name="wfaccess" value="0" data-bind="checked: access" autocomplete="off">Public
				</label>
				<label class="btn btn-light-blue form-check-label active">
    				<input class="form-check-input" style="horizonal-align:left"  type="radio" name="wfaccess" value="1" data-bind="checked: access" autocomplete="off">Shared
    				<input type="text" id="wfusers" placeholder="Users" style="width: 300px;" data-bind="value: users">
				</label>
                  
             </div>
            
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addSample" class="btn btn-primary">Add</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>

<div class="modal fade" id="file-upload-dialog" tabindex="-1"
	role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
				</button>
				<h4 class="modal-title" id="uploadModalLabel">File Upload</h4>
			</div>

			<!-- Modal Body -->
			<div class="modal-body">
				<form id="upload-file" class="form-horizontal" role="form"
					method=POST enctype=multipart/form-data>

					<div class="form-group row">
						<div class="col-sm-offset-2 col-sm-10">
						 <label for="upload">Choose file(s)</label>
						<input type="file" class="form-control-file" id="upload" multiple>
						</div>
					</div>
					<hr />

					<div class="form-group row">
						<label for="filename" class="col-sm-2 col-form-label">File Name</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="inputFilename">
						</div>
					</div>
					
					<div class="form-group row input-group mb-3">
					  <div class="input-group-prepend col-sm-2">
					    <label class="col-form-label" for="inputVisualizer">Visualizers</label>
					  </div>
					  <div class="custom-select col-sm-10">
					  <select class="custom-select" data-bind="options: visualizers, optionsCaption: 'Choose visualizer...'" id="inputVisualizer"></select>
					  </div>
					</div>
					
					<div class="form-group row">
						<label for="inputAnnotations" class="col-sm-2 col-form-label">Annotations</label>
						<div class="col-sm-10">
							<input type="text" class="form-control" id="inputAnnotations">
						</div>
					</div>
					
					<div class="form-group row input-group mb-3">
					  <div class="input-group-prepend col-sm-2">
					    <label class="input-group-text" for="inputMimeType">Mime Types</label>
					  </div>
					  <div class="custom-select col-sm-10">
					  <select class="custom-select" data-bind="options: mimetypes, optionsCaption: 'Choose MIME Type...'" id="inputMimeType"></select>
					  </div>
					</div>

					<div class="form-group row">
						<div class="col-sm-offset-2 col-sm-10">
							<button data-bind="click: upload" type="button"
								class="btn btn-primary" id="upload-file-btn"
								data-dismiss="modal">Upload</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<div id="update-metadata-dialog" class="modal fade" tabindex="=1"
	role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true"
	style="width: 50%; height: 50%; background: #fff; overflow-y: auto; max-height: calc(100vh - 210px);">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal"
			aria-hidden="true">&times;</button>
		<h3 id="addDialogLabel">Update Metadata</h3>
	</div>
	<div class="modal-body">
		<form class="form-horizontal">
			<div class="control-group">
				<div class="controls">
					<ul class="nav nav-tabs">
						<li class="active"><a href="#generaltab" data-toggle="tab">General</a></li>
						<li><a href="#visualizertab" data-toggle="tab">Visualizers</a></li>
						<li><a href="#annotationtab" data-toggle="tab">Annotations</a></li>
						<li><a href="#mimetypestab" data-toggle="tab">MIME Types</a></li>
						<li><a href="#propertiestab" data-toggle="tab">Properties</a></li>
					</ul>
					<div class="tab-content ">
						<div class="tab-pane fade in active" id="generaltab">
							<div class="container">
								<!-- Default input -->
								<label for="filename">Filename</label>
								<input type="text" id="filename" class="form-control" data-bind="value: filename">
								<div class="table-wrapper">
									<table class="table table-bordered"
										data-bind="foreach: systemProperties.items">
										<thead>
											<tr>
												<th>Key</th>
												<th>Value</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<th class="justify-content-right" scope="row"
													data-bind="text: key"></th>
												<td class="justify-content-left" data-bind="text: value"></td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
						<div class="tab-pane fade" id="visualizertab"></div>
						<div class="container">
								<div class="table-wrapper">
									<div class="table-title">
										<div class="row justify-content-end">
											<div class="col-sm-12">
												<button type="button" class="btn btn-info add-new">
													<i class="fa fa-plus"></i> Add New
												</button>
											</div>
										</div>
									</div>
									<table class="table table-bordered"
										data-bind="foreach: visualizers.items">
										<thead>
											<tr>
												<th>Key</th>
												<th>Value</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td scope="row" data-bind="text: key"></td>
												<td data-bind="text: value"></td>
												<td>
													<a class="add" title="Add" data-toggle="tooltip"><i class="material-icons">&#xE03B;</i></a>
													<a class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons">&#xE254;</i></a>
													<a class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						<div class="tab-pane fade" id="annotationtab"></div>
						<div class="tab-pane fade" id="mimetypestab"></div>
						<div class="container">
								<div class="table-wrapper">
									<div class="table-title">
										<div class="row justify-content-end">
											<div class="col-sm-12">
												<button type="button" class="btn btn-info add-new">
													<i class="fa fa-plus"></i> Add New
												</button>
											</div>
										</div>
									</div>
									<table class="table table-bordered"
										data-bind="foreach: visualizers.items">
										<thead>
											<tr>
												<th>Key</th>
												<th>Value</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td scope="row" data-bind="text: key"></td>
												<td data-bind="text: value"></td>
												<td>
													<a class="add" title="Add" data-toggle="tooltip"><i class="material-icons">&#xE03B;</i></a>
													<a class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons">&#xE254;</i></a>
													<a class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						<div class="tab-pane fade" id="propertiestab">
							<div class="container">
								<div class="table-wrapper">
									<div class="table-title">
										<div class="row justify-content-end">
											<div class="col-sm-12">
												<button type="button" class="btn btn-info add-new">
													<i class="fa fa-plus"></i> Add New
												</button>
											</div>
										</div>
									</div>
									<table class="table table-bordered"
										data-bind="foreach: properties.items">
										<thead>
											<tr>
												<th>Key</th>
												<th>Value</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td scope="row" data-bind="text: key"></td>
												<td data-bind="text: value"></td>
												<td>
													<a class="add" title="Add" data-toggle="tooltip"><i class="material-icons">&#xE03B;</i></a>
													<a class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons">&#xE254;</i></a>
													<a class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<!--         <button data-bind="click: update" class="btn btn-primary">Save</button> -->
		<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
		<div>
			<span class="label label-default" id="add-metadata-info"></span>
		</div>
	</div>
</div>

<!-- <div class="modal fade" id="rename-filefolder-dialog" tabindex="-1" role="dialog" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            Modal Header
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                       <span aria-hidden="true">&times;</span>
                       <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="renameModalLabel">
                    File/Folder Rename
                </h4>
            </div>
            
            Modal Body
            <div class="modal-body">
                <form id="rename-filefolder" class="form-horizontal" role="form" method=POST enctype=multipart/form-data>
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <input type="text" name="rename-filefolder-text" id="rename-filefolder-text">
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                      <button type="button" class="btn btn-default" id="rename-filefolder-btn" data-dismiss="modal" data-bind="click: rename">Rename</button>
                    </div>
                  </div>
                </form>
            </div>
        </div>
    </div>
</div> -->

<div id="edit" class="modal fade" tabindex="=1" role="dialog" aria-labelledby="editDialogLabel" aria-hidden="true" style="background: #fff">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="editDialogLabel">Edit Task</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputTask">Task</label>
                <div class="controls">
                    <input data-bind="value: module" type="text" id="inputTask" placeholder="Module" style="width: 150px;">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputDescription">Name</label>
                <div class="controls">
                    <input data-bind="value: name" type="text" id="inputDescription" placeholder="Name" style="width: 300px;">
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <label class="checkbox">
                        <input type="checkbox"> Done
                    </label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click:editTask" class="btn btn-primary">Update Task</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
</div>
		
<!-- <div id="metadataView" class="container-fluid" aria-hidden="true"> -->
<!-- 	<h4>Metadata information</h4> -->
<!-- 	<div class="row-fluid mb-3"> -->
<!-- 		<div class="col-6 themed-grid-col"> -->
<!-- 			<div class="row-fluid mb-3"> -->
<!-- 				<span>System Properties</span> -->
				
<!-- 				<div data-bind="foreach: systemProperties.items"> -->
<!-- 					<div class="row-fluid" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }"> -->
<!-- 						<div class="col-6 themed-grid-col"> -->
<!-- 							<span data-bind="text: key"></span>  -->
<!-- 						</div> -->
<!-- 						<div class="col-6 themed-grid-col"> -->
<!-- 							<span data-bind="text: value"></span>  -->
<!-- 						</div> -->
<!-- 					</div> -->
<!-- 				</div> -->
<!-- 			</div> -->
<!-- 			<div class="row-fluid mb-3"> -->
<!-- 				<span>Visualizers</span> -->
<!-- 			</div> -->
<!-- 			<div class="row-fluid"> -->
<!-- 				<span>Visualizers</span> -->
<!-- 			</div> -->
<!-- 		</div> -->
<!-- 		<div class="col-6 themed-grid-col"> -->
<!-- 			<div class="row-fluid"> -->
<!-- 				<span>Visualizers</span> -->
<!-- 			</div> -->
<!-- 			<div class="row-fluid"> -->
<!-- 				<span>Visualizers</span> -->
<!-- 			</div> -->
<!-- 			<div class="row-fluid"> -->
<!-- 				<span>Visualizers</span> -->
<!-- 			</div> -->
<!-- 		</div> -->
<!-- 	</div> -->
<!-- </div> -->

<div id="metadataView" class="container-fluid" aria-hidden="true">
	<h3 class="text-info mx-auto">Metadata Information</h3>
	
	<h4 class="text-info">System Properties</h4>
	<table class="table" data-bind="foreach: systemProperties.items">
		<tbody>
			<tr>
				<th scope="row" data-bind="text: key"></th>
				<td data-bind="text: value"></td>
			</tr>
		</tbody>
	</table>
	
	<h4 class="text-info">Visualizers</h4>
	<table class="table" data-bind="foreach: visualizers.items">
		<tbody>
			<tr>
				<th scope="row" data-bind="text: key"></th>
				<td data-bind="text: value"></td>
			</tr>
		</tbody>
	</table>
	
	<h4 class="text-info">Annotations</h4>
	<table class="table" data-bind="foreach: annotations.items">
		<tbody>
			<tr>
				<th scope="row" data-bind="text: value"></th>
			</tr>
		</tbody>
	</table>
	
	<h4 class="text-info">MIME Types</h4>
	<table class="table" data-bind="foreach: mimetypes.items">
		<tbody>
			<tr>
				<th scope="row" data-bind="text: key"></th>
				<td data-bind="text: value"></td>
			</tr>
		</tbody>
	</table>
	
	<h4 class="text-info">Properties</h4>
	<table class="table" data-bind="foreach: properties.items">
		<tbody>
			<tr>
				<th scope="row" data-bind="text: key"></th>
				<td data-bind="text: value"></td>
			</tr>
		</tbody>
	</table>
</div>

<!-- 
<div id="metadataView" class="container-fluid" aria-hidden="true">
	<h3>Metadata information</h3>
	<div class="row-fluid mb-3">
    <div class="col-md-6 themed-grid-col">
	   	<div class="row-fluid mb-3">
			<span>System Properties</span>
		
			<div data-bind="foreach: systemProperties.items">
				<div class="row-fluid mb-3" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: key"></span> 
					</div>
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: value"></span> 
					</div>
				</div>
			</div>
	   </div>
			
		<div class="row-fluid mb-3">
			<span>Visualizers</span>
			<div data-bind="foreach: visualizers.items">
				<div class="row-fluid mb-3" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: key"></span> 
					</div>
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: value"></span> 
					</div>
				</div>
			</div>
		</div>
			
		<div class="row-fluid mb-3">
			<span>Annotations</span>
			<div data-bind="foreach: annotations">
				<div class="row-fluid mb-3" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
					<div class="col themed-grid-col">
						<span data-bind="text: $data"></span> 
					</div>
				</div>
			</div>
		</div>
    </div>
    <div class="col-md-6 themed-grid-col">
    	<div class="row-fluid">
			<span>Mime Types</span>
			<div data-bind="foreach: mimetypes">
				<div class="row-fluid mb-3" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
					<div class="col themed-grid-col">
						<span data-bind="text: $rawData"></span> 
					</div>
				</div>
			</div>
		</div>
			
    	<div class="row-fluid mb-3">
			<span>Properties</span>
			
			<div data-bind="foreach: properties.items">
				<div class="row-fluid mb-3" data-bind="css: { 'odd-row': $index() % 2 === 0, 'even-row': $index() % 2 === 1 }">
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: key"></span> 
					</div>
					<div class="col-md-6 themed-grid-col">
						<span data-bind="text: value"></span> 
					</div>
				</div>
			</div>
		</div>
    </div>
  </div>
</div>
 -->
<div class="modal fade" id="save-needed" tabindex="-1" role="dialog" aria-labelledby="saveNeededModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                       <span aria-hidden="true">&times;</span>
                       <span class="sr-only">Close</span>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <h4 class="modal-title" id="saveNeededModalLabel">
                    You must save the workflow before running it. Do you want to save it now?
                </h4>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-default" data-dismiss="modal" id="save-needed-yes" data-dismiss="modal">Yes</button>
                 <button type="button" class="btn" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script type="text/javascript">
    var refreshId = 0;
    var workflowId = 0;
    var reportId = 0;
    var isDirty = false;
    var username = "{{ username }}";
	var currentBiowlTab;
	   
    function copy2Editor(text, type) {
    	 $.ajax({
             url: text
         })
         .then(function(content) {
             // Set the tooltip content upon successful retrieval
             if (!content) {
             	content = "";
             }
             else {
                 content = JSON.parse(content);
                 
                 var pos = editor.selection.getCursor();             
                 editor.session.insert(pos, type == 0 ? content.example + "\r\n": content.example2 + "\r\n");
                 editor.focus();
             }
         });
    }
    
    $(window).on('load', function() {
    	 
    	centerDialog = function(dlg) {
            var windowHeight = $(window).height();
            var windowWidth = $(window).width();
            var boxHeight = dlg.height();
            var boxWidth = dlg.width();
            dlg.css({'margin-left' : ((windowWidth - boxWidth )/2), 'margin-top' : ((windowHeight - boxHeight)/2)});
        }
    	
		$('#tree').on("dblclick.jstree", function (e) {
		 	  var tree = $(this).jstree();
		 	  var node = tree.get_node(event.target);
		 	  copyDataPathToEditor(node.original);
		});
		
		$('#tree').on("select_node.jstree", function (e, data) {
			
			if ($("#metatab").length == 0)
				return;
			showMetadata(data.node.original.path);
		});
		
    	$('#refresh').hide();
        $('.draggable-functions').each(function() {
            // inner scope
            var phrase = $(this);
             
             $(this).find('div.draggable-func').each(function() {
                 // cache jquery object
                 var current = $(this);
                current.addClass("draggable-func");
                 
                 current.draggable({
                     revert : 'invalid',
                     stack : '.draggable-func',
                     helper : 'clone'
                 });
                 
                 
//                  current.on("dragstart", function(e) {
//                 	 e.originalEvent.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
//                  current.bind('dragstart', function(e) {
//                         e.dataTransfer.setData("text/plain", this.textContent)
//                  });
                 
             });
         });
        
        $('.draggable-samples').each(function() {
            // inner scope
            var phrase = $(this);
            
            $(this).find('div.draggable-sample').each(function() {
                // cache jquery object
                var current = $(this);
                current.draggable({
                    revert : 'invalid',
                    stack : '.draggable-sample',
                    helper : 'clone'
                });
            });
        });
        
        $(document).ready(function() {
            //$('[data-toggle="tooltip"]').tooltip();
            
            $('.menu_button').click(function() {
          		$(this).addClass('selected').siblings().removeClass('selected')
        	});
            
          //Toggle fullscreen
            $("#panel-fullscreen").click(function (e) {
                e.preventDefault();
                
                var $this = $(this);
            
                if ($this.children('i').hasClass('glyphicon-resize-full'))
                {
                    $this.children('i').removeClass('glyphicon-resize-full');
                    $this.children('i').addClass('glyphicon-resize-small');
                }
                else if ($this.children('i').hasClass('glyphicon-resize-small'))
                {
                    $this.children('i').removeClass('glyphicon-resize-small');
                    $this.children('i').addClass('glyphicon-resize-full');
                }
                $(this).closest('.panel').toggleClass('panel-fullscreen');
                editor.resize();
            });
          
            $("#panel-about").click(function (e) {
                e.preventDefault();
   				window.open("static/biodsl-help.html#syntax", '_blank');
            });
            
            $("#panel-fontsize a").on('click', function (e) {
                e.preventDefault();
   				
   				editor.setFontSize($(e.target).text() + 'pt');
            });
            
            
        });
        
    });

    var AjaxCalls = function(username, password) {
    	var self = this;
    	self.username = username;
    	self.password = password;
    	
    	self.form = function(uri, method, data, asyncParam = true) {
            var request = {
                    url: uri,
                    type: method,
                    async: asyncParam,
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 
                            "Basic " + btoa(self.username + ":" + self.password));
                    },
                    error: function(jqXHR) {
                        showXHRText(jqXHR);
                    }
                };
                return $.ajax(request);
        }
        
        self.simple = function(uri, method, data, asyncParam = true) {
            var request = {
                    url: uri,
                    type: method,
                    async: asyncParam,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: data,
//                     beforeSend: function (xhr) {
//                         xhr.setRequestHeader("Authorization", 
//                             "Basic " + btoa(self.username + ":" + self.password));
//                     },
                    error: function(jqXHR) {
                        showXHRText(jqXHR);
                    }
                };
                return $.ajax(request);
        }
    }
    
    ajaxcalls = new AjaxCalls('mainulhossain@gmail.com', 'mainul');
    
//     $('#tree').bind('mousewheel', function(e) {
//     	  $(this).scrollTop($(this).scrollTop() - e.originalEvent.wheelDeltaY);
//     	  return false;
//     	});
    
    // Create the View Model.
    var DataSourceViewModel = function() {
      var self = this;
      self.init = false;
      self.dataSourcesURI = '/datasources';
      self.dataSources = ko.observableArray();
      self.expandedNodes = [];
      self.searchDataSource = ko.observable();
      self.waittime = 5000; // for throttle
      self.tree = $('#tree');
      
      self.visualizers = ko.observableArray();
      self.mimetypes = ko.observableArray(["xx-pp", "yy-qq"]);
                  
      self.findExpandibleNodes = function(text) {
    	var options = {
    		    ignoreCase: true,
    		    exactMatch: false,
    		    revealResults: true,
    		  };
        return $('#tree').treeview('search', [ text, options ]);
      };
    
      self.searchDataSource.subscribe(function () {
    	  self.tree.jstree('search', self.searchDataSource());
      });
           
      self.beginFileUpload = function() {
          centerDialog($('#file-upload-dialog'));
          self.loadMetadataProperties();
          ko.cleanNode($("#file-upload-dialog")[0]);
          ko.applyBindings(dataSourceViewModel, $("#file-upload-dialog")[0]);
          $('#file-upload-dialog').modal('show');
      }
      
      self.beginUpdateMetadata= function() {
    	  centerDialog($('#update-metadata-dialog'));
    	  var node = dataSourceViewModel.selectedNode().original;
    	  if (node === undefined)
    		  return;
    	  
    	  metadataViewModel.load(node.path);
    	  $('#update-metadata-dialog').modal('show');
      }
      
      self.loadMetadataProperties = function() {

          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'metadataproperties': true }).done(function(data) {
			
        	  self.visualizers = ko.observableArray(data['visualizers']);
        	  self.mimetypes = ko.observableArray();
        	  $.each(data['mimetypes'], function(key, value){
        		  self.mimetypes.push(ko.observable(key + ", " + value))
        	  });
                        
          }).fail(function(jqXHR) {
              showXHRText(jqXHR);
          });
      }

      
      self.load = function(recursive) {
    	  /*if (self.init) {
	    	  node = self.selectedNode();
	          if (node !== undefined) {
	        	  self.loadItem(node, recursive)
	        	  return;
	          }
    	  }*/

          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'recursive': recursive }).done(function(data) {
        	  self.dataSources(data.datasources);
        	  
        	 /*  self.tree.jstree(true).settings.core.data = self.dataSources();
        	  self.tree.jstree(true).refresh(); */
        	  
              ko.cleanNode($("#dataSourcesPanel")[0]);
              ko.applyBindings(self, $("#dataSourcesPanel")[0]);
              //ko.mapping.fromJS($("#dataSourcesPanel")[0], self);
              
              /*$('#tree').find('li.list-group-item').each(function() {
                  // cache jquery object
                  var current = $(this);
                  current.draggable({
                      revert : 'invalid',
                      stack : '.draggable-data',
                      helper : 'clone',
                      zIndex:10000
                  });
              });*/
              
//               for (node in self.expandedNodes) {
//               	$('#tree').treeview('expandNode', [ parseInt(self.expandedNodes[node]), { levels: 0, silent: true } ]);
//               }
                        
          }).fail(function(jqXHR) {
              showXHRText(jqXHR);
          });
      }
      
      self.getItemByPath = function(source, path) {
    	  if (source.path === path)
    		  return source;
    	  
    	  if (source.children !== undefined || source.children != null) {
	    	  for(var i =0; i < source.children.length; ++i){
	    		  
	    		  var subNode = self.getItemByPath(source.children[i], path);
	    		  if (subNode)
	    			  return subNode;
	    	  }
    	  }
    		
    	  return null;	
      }
      
      self.loadItem = function(node, recursive = true) {
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'load': node.original.path, 'recursive': recursive }).done(function(data) {
              
              var dataSources = self.dataSources();
              
              for(var i=0; i < dataSources.length; ++i){
            	  
            	  var item = self.getItemByPath(dataSources[i], data.path);
            	  if (item != null) {
                  	item.text = data.text;
                  	item.nodes = data.nodes;
                    item.loaded = data.loaded;
                    
                    ko.cleanNode($("#dataSourcesPanel")[0]);
                    ko.applyBindings(self, $("#dataSourcesPanel")[0]);
                    
//                     for (node in self.expandedNodes)
//                         $('#tree').jstree(true). ('expandNode', [ parseInt(self.expandedNodes[node]), { levels: 0, silent: true } ]);
                        
                  	break;
            	  }
              }
          }).fail(function(jqXHR) {
              showXHRText(jqXHR);
          });
      }
      
      self.selectedNode = function()
      {
    	  node = $('#tree').jstree("get_selected")
    	  return $('#tree').jstree().get_selected(true)[0];
      }
      
      self.parentNode = function(node)
      {
    	  return node.parentNode;
      }
      
      self.upload = function() {

     	  $('#file-upload-dialog').modal('hide');
     	 
          var files = $("#upload").get(0).files;
          var formdata = new FormData();
          formdata.append('upload', files[0]); //use get('files')[0]
          node = self.selectedNode();
          if (node === undefined)
        	  return;
          formdata.append('path', node.original.path);//you can append it to formdata with a proper parameter name
          formdata.append('filename', $("#inputFilename").val());
          formdata.append('visualizer', $("#inputVisualizer").val());
		  formdata.append('annotations', $("#inputAnnotations")[0].value);
		  formdata.append('mimetype', $("#inputMimeType").val());
		  
          ajaxcalls.form(self.dataSourcesURI, 'POST', formdata).done(function(data) {
        	  self.loadItem(node);
          });
       }
      
	  self.about = function() {

		  window.open("static/biodsl-help.html#datasources", '_blank');
      }
      
      self.download = $.debounce(500, function() {
    	  
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          $.redirect(self.dataSourcesURI, { 'download': node.path }, "POST", "_blank");
      });
            
      self.addFolder = $.debounce(500, function() {
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'addfolder': node.original.path }).done(function(data) {
        	  self.load();
        	  $('#tree').jstree(true).select_node(node.id);
          });
      });
      
      self.remove = $.debounce(500, function() {
    	  node = self.selectedNode();
          if (node === undefined)
              return;
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'delete': node.original.path }).done(function(data) {
          	  var parentNode = self.parentNode(node);
          	  if (parentNode === undefined)
          	  	return;
          	  
          	  var siblings = parentNode.children;
          	  if (siblings !== undefined && siblings.length > 0)
          	  	sibling = siblings[0].path;
        	  self.loadItem(parentNode);
        	  
        	  if (sibling === undefined)
        	  	$('#tree').jstree(true).select_node(node.nodeId);
        	  else {
        	  	siblingNode = self.getItemByPath(parentNode, sibling);
        	  	$('#tree').treeview('selectNode', siblingNode.nodeId);
        	  }
          });
      });
      
      /* self.rename = function() {
    	  $('#rename-filefolder-dialog').modal('hide');
    	  
          node = self.selectedNode();
          if (node === undefined)
              return;
          
          ajaxcalls.simple(self.dataSourcesURI, 'GET', { 'oldpath': node.path, 'rename': $('#rename-filefolder-text').val() }).done(function(data) {
        	  self.loadItem(self.parentNode(node));
          });
      } */
      
      self.load(true);
      self.init = true;
    }
   
   // Last trigger node Id
   var lastSelectedNodeId = null;
   // Last time trigger 
   var lastSelectTime = null;
   
   // Custom business method 
   function copyDataPathToEditor(data){
       var pos = editor.selection.getCursor();             
       editor.session.insert(pos,  "'" + data.path + "'");
       editor.focus();
   }
   
   function loadMetaData(path){
	   metadataViewModel.load(path);
		if ($("#metatab").length == 0) {
			createNewTab("metatab", "Metadata",  "fade in scriptstyle");
		}
   }
   
	function showMetadata(path) {
		loadMetaData(path);
		if ($("#metadataView").parent('div#metatab').length == 0)
		{
			$('#metatab').append($("#metadataView"));
			$("#metadataView").show();
		}
	}
	
function typeInTextarea(el, newText) {
  var start = el.selectionStart;
  var end = el.selectionEnd;
  var text = el.value;

  var before = "";
  var after = "";
  if (text != null) {
	if (start != null)
		before =  text.substring(0, start);
	else
		start = text.length;
		
	if (end != null)
		after = text.substring(end, text.length);
  }
  else
	start = 0;
  
  el.value = (before + newText + after)
  el.selectionStart = el.selectionEnd = start + newText.length
  el.focus()
}
   
   function serviceHelpRef(href) {
	   if (href) {
		   return "<a href='static/" + href + "' target='_blank'>" + "More...</a>";
	   }
	   else {
		   return "";
	   }
   }
   
/* 	ko.bindingHandlers.qTip = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
				content: {
	                text: function(event, api) {
	                	var url = "/functions?tooltip&name=" + viewModel.name() + "&package=" + viewModel.package_name();
	                    $.ajax({
	                        url: url
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        if (!content) {
	                        	content = "";
	                        }
	                        else {
		                        content = JSON.parse(content);
		                        tooltip = "<p>Name: " + content.name + (content.package_name && content.package_name.length ? "<br>Package: " + content.package_name : "") + "<br>Access: " + content.access + "</p>"
		                        if (content.example) {
		                        	tooltip += '<p><a href="javascript:void(0);" onclick="copy2Editor(\'' + url + '\', 0); return false;">Add: </a>' + content.example;	
		                        }
		                        if (content.example2 && content.example !== content.example2) {
		                        	tooltip += '<br><a href="javascript:void(0);" onclick="copy2Editor(\'' + url + '\', 1); return false;">Add: </a>' + content.example2;	
		                        }
		                        if (content.returns) {
		                        	tooltip += "<br>Returns: " + content.returns;
		                        }
		                        tooltip += "</p>";
		                        	
		                        var descHref = (content.desc && content.desc.length ? "Desc: " + content.desc : "") + (content.href && content.href.length ? "<br>" + serviceHelpRef(content.href) : ""); 
		                        if (descHref !== undefined && descHref.length) {
		                        	tooltip += "<p>" + descHref + "</p>";
		                        }
		                        tooltip += "<p>Double click item to insert into code editor.</p>";
	                        }
	                        api.set('content.text', tooltip);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	        
	                    //return ''; // Set some initial text
	                }
	            },
				show: {
					delay: 1000
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left',
	                viewport: $(window),
	                effect: false
	            }
	        });
	        //ko.applyBindingAccessorsToNode(element, {visible: valueAccessor()});
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
// 	        var visible = ko.utils.unwrapObservable(valueAccessor());
// 	        if(!visible) {
// 	            $(element).qtip('hide');
// 	        }
	    }
	};
 */	
	ko.bindingHandlers.qTipWf = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
				content: {
	                text: function(event, api) {
	                    $.ajax({
	                        url: "/samples?tooltip=" + viewModel.id()
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        if (!content) {
	                        	content = "";
	                        }
	                        else {
		                        content = JSON.parse(content);
		                        tooltip = "<p>Name: " + content.name + "<br>Owner: " + content.user + "<br>Public: " + content.public + "</p>"
		                        +"<p>Desc: " + content.desc + "</p>"
		                        + "<p>Double click to insert into code editor</p>";
	                        }
	                        api.set('content.text', tooltip);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	        
	                    //return ''; // Set some initial text
	                }
	            },
				show: {
					delay: 1000
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left',
	                viewport: $(window),
	                effect: false
	            }
	        });
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	    }
	};

	ko.bindingHandlers.qTipDs = {
	    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	        $(element).qtip({
				style: {
                	classes: 'qtip-bootstrap'
            	},
				content: {
	                text: function(event, api) {
	                    $.ajax({
	                        url: "/runnables?tooltip=" + viewModel.id() //api.elements.target.attr('href') // Use href attribute as URL
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        content = JSON.parse(content);
	                        content = "<p>Name: " + content.name + "</p><p>Created: " + content.created_on + "<br>Modified: " + content.modified_on + "<br>Duration: " + content.duration + 
	                        	"(s)</p><p>Status: " + content.status + (content.err && content.err.length > 0 ? "<br>Error: " + content.err : "") + "</p><p>Double click to show in report.<br>Check to pin job to report.</p>";

	                        api.set('content.text', content);
	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                        api.set('content.text', status + ': ' + error);
	                    });
	                    //return ''; // Set some initial text
	                }
	            },
				show: {
					delay: 1000
				},
	            hide: {
					delay: 0,
          			fixed: true
     			},
	            position: {
	                my: 'left top',
	                at: 'bottom left',
	                viewport: $(window),
	                effect: false
	            }
	        });
	    },
	    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
	    }
	};
  
   function customMenu(node)
   {
       var items = {
           'item1' : {
        	   'label': 'To editor',
        	   'icon': 'glyphicon glyphicon-paste',
        	   'separator_after': true,
               'action' : function(data) {
            	   var inst = $.jstree.reference(data.reference);
            	   var node = inst.get_node(data.reference);
            	   	copyDataPathToEditor(node.original);
            	   }
           },
           'item2' : {
               'label' : 'To args',
               'icon': 'glyphicon glyphicon-paste',
               'action' : function(data) {
            	   var inst = $.jstree.reference(data.reference);
            	   var node = inst.get_node(data.reference);
            	   	typeInTextarea(document.getElementById("args"), "'" + node.original.path + "'");
            	   }
           },
           'item3' : {
               'label' : 'Show Metadata',
               'icon': 'glyphicon glyphicon-th',
               'action' : function(data) {
            	   var inst = $.jstree.reference(data.reference);
            	   var node = inst.get_node(data.reference);
            	   showMetadata(node.original.path);
            	   showTab("metatab");
            	}
           }
       }

       if (node.type === 'level_1') {
           delete items.item2;
       } else if (node.type === 'level_2') {
           delete items.item1;
       }

       return items;
   }
   
   ko.bindingHandlers.jstree = {
	    buildTree: function (element, treeData) {
	        $(element).jstree('destroy');
	        $(element).jstree({
	            'core': {
	                'animation': 0,
	                'check_callback': true,
	                'multiple': false,
	                'data': treeData
	            },
	            'contextmenu': {
	            	'items': customMenu
	            },
	            'types': {
	                'folder': {
	                	'valid_children': ['folder','file']
	                },
	                'file': {
	                	'icon': 'glyphicon glyphicon-file',
	                	'max_depth': 0
	                }
	            },
	            "search": {
	    			"case_insensitive": true,
	    			"show_only_matches" : true
	    		},
                'plugins': ['search', 'state', 'types', 'wholerow', 'contextmenu']
	        });
	    },
	    update: function (element, valueAccessor) {
	        var treeData = ko.unwrap(valueAccessor());
	        ko.bindingHandlers.jstree.buildTree(element, treeData.data());
	    }
	};
   
   
    // Create the View Model and initialise with initial data 
    var dataSourceViewModel = new DataSourceViewModel();
    ko.applyBindings(dataSourceViewModel, $("#dataSourcesPanel")[0]);
    
//     $('#rename-filefolder-dialog').on('shown.bs.modal', function () {
//     	var node = dataSourceViewModel.selectedNode();
//     	if (node === undefined)
//     		return;
//     	var filename = node.path.replace(/^.*[\\\/]/, '')
//         $('#rename-filefolder-text').val(filename);
//         $('#rename-filefolder-text').focus();
//     });
    
    // configure ace.js for code editor
    var langTools = ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.renderer.setShowGutter(false);
    editor.getSession().setMode("ace/mode/python");
    editor.setOptions({
    	highlightSelectedWord: true, 
    	enableBasicAutocompletion: true,
    	autoScrollEditorIntoView: true,
    	fontSize: "11pt"
    });
    editor.renderer.setOptions({
    	showGutter: true, 
    	displayIndentGuides: true
    });
    //editor.setKeyboardHandler("ace/keyboard/vim");
    //editor.setTheme("ace/theme/idle_fingers");
    //editor.setTheme("ace/theme/twilight");
    editor.setTheme("ace/theme/iplastic");
    editor.setShowPrintMargin(false);
    editor.on("input", function() {
        isDirty = !editor.session.getUndoManager().isClean();
    });
    
    /*var staticWordCompleter = {
   	    getCompletions: function(editor, session, pos, prefix, callback) {
   	        var wordList = ["foo", "bar", "baz"];
   	        callback(null, wordList.map(function(word) {
   	            return {
   	                caption: word,
   	                value: word,
   	                meta: "static"
   	            };
   	        }));

   	    }
   	}*/

   	
   	if (localStorage[username.concat('_inputVals')] !== undefined)
   		editor.session.setValue(JSON.parse(localStorage[username.concat('_inputVals')]));

    var dynamicWordCompleter = {
     	getCompletions: function(editor, session, pos, prefix, callback) {
 	    $.getJSON('/functions?codecompletion=' + prefix,
 	      function(tagList) {
 	        callback(null, tagList.functions.map(function(qtag) {
 	          return { caption: qtag.name + '(' + qtag.package_name + ')', value: qtag.example, meta: qtag.group}
 	      }));
 	    })
 	   }
  	}
    
   	langTools.setCompleters([dynamicWordCompleter])
   	// or 
   	//editor.completers = [staticWordCompleter]
    
//     editor.droppable({

//         activeClass: "ui-state-default",
//         hoverClass: "ui-state-hover",
//         accept: ":not(.ui-sortable-helper)",
        
//         drop: function(event, ui) {
//           var pos = editor.renderer.screenToTextCoordinates(event.clientX, event.clientY)
//           var v = ko.dataFor(ui.draggable[0]);
//           example = ''
//           if (v)
//         	  if (v.example)
//         		  example = v.example();
//         	  else if (v.sample)
//         		  example = v.sample();
//               else {
//             	  node = $('#tree').treeview('getNode', $(ui.draggable[0]).data('nodeid'));
//             	  if (node){
//             		  example = node.path;
// //             		  path = split(node.path, ';');
// //             		  if (path.length >= 2)
// //             			  example = node[]
//             	  }
//             	  else
//             		  example = v.name() + "()";
//               }
//           editor.session.insert(pos, example);
//           editor.focus();
//           return true;
//         }
//       });

     
     function TasksViewModel() {
         var self = this;
         self.tasksURI = '/functions';
         self.graphsURI = '/graphs';
         self.username = "";
         self.password = "";
         self.tasks = ko.observableArray();
         self.taskFilter = ko.observable("");
		 this.filteredTasks = ko.computed(function(){
			 return this.tasks().filter(function(task){
				 if(!self.taskFilter() || task.name().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1
	       		   || task.package_name().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1
	       		   || task.group().toLowerCase().indexOf(self.taskFilter().toLowerCase()) !== -1)
	            return task;
	      	});
		 },this);

         self.serviceaccesstypes = ko.observableArray([
         	{
         		Id: 0,
         		Name: "Public"
         	}, 
         	{
       	  		Id: 1,
       	  		Name: "Shared"
       	  	}, 
         	{
       	  		Id: 2,
       	  		Name: "Private"
       	  	}]);
         
         self.selectedServiceAccessType = ko.observable({
     	  	Id: 0,
   	  		Name: "Public"
   		});
         
         self.categories = ko.observableArray([{
         	  Id: 0,
         	  Name: "Basic"
         	}, {
         	  Id: 1,
         	  Name: "Advanced"
         	}]);
         
         self.selectedCategory = ko.observable({
       	  Id: 0,
     	  Name: "Basic"
     	});

         self.selectCategory = function(category) {
             self.selectedCategory(category);
           }
         
         self.selectServiceAccessType = function(serviceAccessType) {
             self.selectedServiceAccessType(serviceAccessType);
             self.load();
           }
         
       	self.clearResults = function() {
       		$("#output").val("");
       		$("#error").val("");
       		$("#log tbody").empty();
       		$("#duration").text("0s");
       		printExecStatus("");
       	}

         self.updateTask = function(task, newTask) {
             var i = self.tasks.indexOf(task);
             self.tasks()[i].package_name(newTask.package_name);
             self.tasks()[i].name(newTask.name);
             self.tasks()[i].internal(newTask.internal);
             self.tasks()[i].example(newTask.example);
             self.tasks()[i].example2(newTask.example2);
             self.tasks()[i].desc(newTask.desc);
             self.tasks()[i].runmode(newTask.runmode);
             self.tasks()[i].group(newTask.group);
             self.tasks()[i].href(newTask.href);
         }
         
         self.beginAddLibrary = function() {
        	$("#add-library-info").text("");
			$.getJSON('/functions?demoserviceadd', function(demoservice) {
				addLibraryViewModel.getCodeEditor().setValue(demoservice.demoservice.script, 1);
				addLibraryViewModel.getMapperEditor().setValue(demoservice.demoservice.mapper, 1);
	         	centerDialog($('#add'));
    	         $('#add').modal('show');
 	    	})
         }
         
         self.about = function() {
        	 window.open("static/biodsl-help.html#services", '_blank');
         }
         
         self.updateWorkflow = function(save) {
             var script = $.trim(editor.getSession().getValue());
             if (!script && !workflowId) // || editor.session.getUndoManager().isClean())
           	 	return; // if script empty and workflowId not set, it means (empty) workflow is not set yet.
           	
           	if (!workflowId){
           		
           		if (save) {
           			samplesViewModel.beginAdd();
           			return;
           		}
//            		else {
// 	           		centerDialog($('#save-needed'));
// 	                $('#save-needed').modal('show')
// 	                .on('click', '#save-needed-yes', function(e) {
// 	           			samplesViewModel.beginAdd();
// 	           	    });
//            		}
           		
           	}
           	
           	var formdata = new FormData();
             
             formdata.append('workflowId', parseInt(workflowId));
             formdata.append('script', script);
             
             ajaxcalls.form(self.tasksURI, 'POST', formdata, false).done(function(data) {
             	if (!$.isEmptyObject(data)) {
             		workflowId = parseInt(data['workflowId']);
             		$('#script-name').text(data['name']);
             		editor.session.getUndoManager().markClean();
             	}
             });
         }
         
         self.runBioWL = function(task) {
           self.updateWorkflow();
           if (!workflowId) {
               $("#error").val("Workflow is not updated. Change the code and run again.");
               return;
           }
           
           var script = $.trim(editor.getSession().getValue());
           if (!script)
         	  return;
           
           $('#refresh').show();
           var formdata = new FormData();
           
           formdata.append('workflowId', parseInt(workflowId));
           formdata.append('args', $('#args').val());
           formdata.append('immediate', $('#immediate').prop('checked'));
           self.clearResults();
           ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
         	  $('#refresh').hide();
             	
             	if (data === undefined)
             		return;
             	
             	reportId = parseInt(data.runnableId);
                 
                runnablesViewModel.load();
                runnablesViewModel.loadHistory(reportId, true);
                 
             }).fail(function(jqXHR, textStatus) {
             	$('#refresh').hide();
             	showXHRText(jqXHR);
             });
         }
         
         self.buildGraph = function(task) {
         	self.updateWorkflow();
             if (!$.trim(editor.getSession().getValue()))
           	  return;
             
             var formdata = new FormData();
             
             formdata.append('workflowId', parseInt(workflowId));
             ajaxcalls.form(self.graphsURI, 'POST', formdata).done(function(data) {
               	
               	if (data === undefined)
               		return;
               	data = JSON.parse(data);
               	if ($.isEmptyObject(data))
               		return;
               	
    			d3graph.show(data);
               	
              }).fail(function(jqXHR, textStatus) {
              	$('#refresh').hide();
              	showXHRText(jqXHR);
             });
         }
         
         self.provenance = function() {
         	$.redirect(self.tasksURI, { 'provenance': true }, "POST", "_blank");
        	}
         
         self.generatePythonCode = function(task) {
         	$('#refresh').show();
         	var formdata = new FormData();
             formdata.append('code', editor.getSession().getValue());
             formdata.append('args', $('#args').val());
             formdata.append('immediate', $('#immediate').prop('checked'));
             ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
                 $('#refresh').hide();
                 if (data === undefined)
                     return;
                 
                 data = JSON.parse(data)
                 
                 $("#output").val(data.out);
                 $("#error").val(data.err);
                 $("#log tbody").empty();
                 jsonArray2Table($("#log"), data['log']);
                 printExecStatus(data['status']);
                 $("#duration").text(data.duration + 's');
             });
         }
         self.beginEditLibrary = function(task) {
            // editTaskViewModel.setTask(task);
             $('#edit').modal('show');
         }
         self.edit = function(task, data) {
           ajaxcalls.simple(task.uri(), 'PUT', data).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         self.remove = function(task) {
           ajaxcalls.simple(task.uri(), 'DELETE').done(function() {
                 self.tasks.remove(task);
             });
         }
         self.markInProgress = function(task) {
           ajaxcalls.simple(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         self.markDone = function(task) {
           ajaxcalls.simple(task.uri(), 'PUT', { internal: "" }).done(function(res) {
                 self.updateTask(task, res.task);
             });
         }
         
         self.load = $.debounce(500, function() {
           ajaxcalls.simple(self.tasksURI, 'GET', {'level': 1, 'access': self.selectedServiceAccessType().Id}).done(function(data) {
         	  self.tasks([]);
         	  $.each(data.functions, function(i, f) {
         		  self.tasks.push({
                       package_name: ko.observable(f.package_name),
                       name: ko.observable(f.name),
                       //internal: ko.observable(f.internal),
                       example: ko.observable(f.example),
                       example2: ko.observable(f.example2),
                       desc: ko.observable(f.desc),
                       //runmode: ko.observable(f.runmode),
                       group: ko.observable(f.group),
                       href: ko.observable(f.href),
                       expanded: ko.observable(false)
                   });
         	  });
             }).fail(function(jqXHR) {
                 showXHRText(jqXHR);
             });
         });
         
         self.reload = $.debounce(500, function() {
             ajaxcalls.simple(self.tasksURI, 'GET', {'reload': 1}).done(function(data) {
            	 self.load(); // now load the data
             }).fail(function(jqXHR) {
                   showXHRText(jqXHR);
             });
           });
         
         self.copyToEditor = function(item) {
            var pos = editor.selection.getCursor();             
            editor.session.insert(pos, self.selectedCategory().Id == 0 ? item.example() + "\r\n": item.example2() + "\r\n");
            editor.focus();
        }
         
         self.clicks = 0;
         self.timer = null;
         
         self.copyToEditorDblClick = function(itme, event) {
        	 event.preventDefault();
         }
         self.toggleExpand = function(item, event) {
        	 event.stopPropagation();
        	 
        	 self.clicks++;
        	 if (self.clicks !== 1) {
        		 clearTimeout(self.timer);
        		 self.copyToEditor(item);
        		 self.clicks = 0;
				 return;        		 
        	 }
        	 
        	 self.timer = setTimeout(function(){
        		 self.clicks = 0;
        		 event.preventDefault();
        	 var domItem = $(event.target);
        	 if (item.expanded()) {
        		 item.expanded(false);
        		 $(".expandedtask").remove();
       	    } else {
       	    	$(".expandedtask").remove();
       	      self.tasks().forEach(function(candidateSample) {
       	        candidateSample.expanded(item === candidateSample);
       	        if (item === candidateSample){
       	        	
       	        	var url = "/functions?tooltip&name=" + item.name() + "&package=" + item.package_name();
                   $.ajax({
                       url: url
                   })
                   .then(function(content) {
                       // Set the tooltip content upon successful retrieval
                       if (content){
                        content = JSON.parse(content);
                        
                        tooltip = "<div class=\'expandedtask\' style=\'border:2px solid black;background-color:lightblue\'> <p>Name: " + content.name + (content.package_name && content.package_name.length ? "<br>Package: " + content.package_name : "") + "<br>Access: " + content.access + "</p>"
                        if (content.example) {
                        	tooltip += '<p><a href="javascript:void(0);" onclick="copy2Editor(\'' + url + '\', 0); return false;">Add: </a>' + content.example;	
                        }
                        if (content.example2 && content.example !== content.example2) {
                        	tooltip += '<br><a href="javascript:void(0);" onclick="copy2Editor(\'' + url + '\', 1); return false;">Add: </a>' + content.example2;	
                        }
                        if (content.returns) {
                        	tooltip += "<br>Returns: " + content.returns;
                        }
                        tooltip += "</p>";
                        	
                        var descHref = (content.desc && content.desc.length ? "Desc: " + content.desc : "") + (content.href && content.href.length ? "<br>" + serviceHelpRef(content.href) : ""); 
                        if (descHref !== undefined && descHref.length) {
                        	tooltip += "<p>" + descHref + "</p>";
                        }
                        tooltip += "<p>Double click item to insert into code editor.</p></div>";
                        
                        domItem.parent().append(tooltip);
                       }
                   }, function(xhr, status, error) {
                       // Upon failure... set the tooltip content to error
                   });
       	      };
       	    });
       	    }
        	 }, 300);
     	}
     }
        
       function SamplesViewModel(sampleViewModel) {
           var self = this;
           self.samplesURI = '/samples';
           self.items = ko.observableArray();
           self.sampleViewModel = sampleViewModel;
           self.access = ko.observable("0");
           self.workflowFilter = ko.observable("");
			this.filteredWorkflows = ko.computed(function(){
		       return this.items().filter(function(item){
		           if(!self.workflowFilter() || item.name().toLowerCase().indexOf(self.workflowFilter().toLowerCase()) !== -1)
		             return item;
		       });
  			},this);
			
		  self.about = function() {
	    	  
			  window.open("static/biodsl-help.html#workflows", '_blank');
	      }

           self.remove = function() {
        	   
        	   var item = self.firstSelectedItem();
               if (item == null)
                   return;
               
               ajaxcalls.simple(self.samplesURI, 'POST', { 'delete': item.name }).done(function(data) {
                   self.load();
               });
           }
           
           self.newwf = function() {
        	   workflowId = 0;
        	   $('#script-name').text('New script');
        	   editor.session.setValue("");
        	   $('#args').val('');
           }
           
           self.beginAdd = function() {
        	   var script = editor.getSession().getValue();
        	   if (script.length > 0) {
        		   self.sampleViewModel.getCodeEditor().setValue(script, 1);
        		}
        	   var scriptname = $('#script-name').text();
        	   if (scriptname.length <= 0) {
        		   scriptname = "No Name";
        	   }
        	   self.sampleViewModel.name(scriptname);
               centerDialog($('#addSample'));
               $('#addSample').modal('show');
           }
           
           self.firstSelectedItem = function() {
               var items = self.items();
               for (var i = 0; i < items.length; i++) {
                   if (items[i].selected()){
                       return items[i];
                   }
               }
               return null;
           }
           
           self.copyToEditor = function(item) {
        	   
        	   ajaxcalls.simple(self.samplesURI, 'GET', {'sample_id': item.id}).done(function(data) {
        		   
               	   if ($.isEmptyObject(data))
               		   return;
        		   
        		   var pos = editor.selection.getCursor();        	   
                   editor.session.insert(pos, data['script']);//.join('\r\n'));
                   editor.focus();
                   workflowId = item.id();
                   $('#script-name').text(item.name());
                   
               }).fail(function(jqXHR) {
                   showXHRText(jqXHR);
               });
           }
           
           self.click = function(model){
          		self.load();
          	    return true;
           }
           
           self.load = function() {
               ajaxcalls.simple(self.samplesURI, 'GET', {'access': self.access()}).done(function(data) {
            	   self.items([]);
            	   $.each(data.samples, function(i, s){
            		   self.items.push({
            			   id: ko.observable(s.id),
            			   user:ko.observable(s.user),
                           name: ko.observable(s.name),
                           selected: ko.observable(false)
                       });
            	   });
            	   
               }).fail(function(jqXHR) {
                   showXHRText(jqXHR);
               });
           }
       }
       
       $('input[name="wfaccess"]').change(function(e) { // Select the radio input group

    	    // This returns the value of the checked radio button
    	    // which triggered the event.
    	    if ($(this).val() == 1) {
    	    	$("#wfusers").show();
    	    }
    	    else {
    	    	$("#wfusers").hide();
    	    }
    	});
       
       $("input[name='loadr']").change(function(e) { // Select the radio input group
	   	    if (this.checked) {
	   	    	
	   	    }
	   	    else {
	   	    	
	   	    }
   		});
       
	function CreateAceEditor(editorId, mode, height) {
	            // configure ace.js for code editor
            var mapperArea = $(editorId);
            
            var mapperDiv = $('<div>', {
                position: 'absolute',
                id: 'aceeditor',
                width: mapperArea.width(),
                height: height,//mapperArea.height(),
                'class': mapperArea.attr('class'),
                'css': 'border:2px solid black'
            }).insertBefore(mapperArea);
                
            mapperArea.css('visibility', 'hidden');
            var offset = mapperDiv.offset();
            mapperArea.attr('rows', 1);
            
            var mapperEditor = ace.edit(mapperDiv[0]);
            mapperEditor.renderer.setShowGutter(false);
            mapperEditor.getSession().setValue(mapperArea.val());
            mapperEditor.getSession().setMode(mode);
            mapperEditor.setOptions({highlightSelectedWord: true, enableBasicAutocompletion: true});
            mapperEditor.renderer.setOptions({showGutter: true, displayIndentGuides: true});
            //editor.setKeyboardHandler("ace/keyboard/vim");
            //editor.setTheme("ace/theme/idle_fingers");
            //editor.setTheme("ace/theme/twilight");
            mapperEditor.setTheme("ace/theme/iplastic");
//             editor.setOptions({       
//                 fontSize: "12pt"
//               });

		return mapperEditor;
		}
        function SampleViewModel() {
            var self = this;
            self.samplesURI = '/samples';
            
            self.name = ko.observable("No Name");
            self.desc = ko.observable("No Description");
            self.access = ko.observable("2");
            self.users = ko.observable();

			self.sampleEditor = CreateAceEditor("#sample", "ace/mode/python", 300);
 
            self.addSample = function(task) {
                $('#addSample').modal('hide');
                
                var formdata = new FormData();
                formdata.append('sample', self.sampleEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
                
                if (self.name() === undefined)
                	return;
                formdata.append('name', self.name());
                
                if (self.desc() !== undefined)
                	formdata.append('desc', self.desc());
                
                if (self.access() !== undefined) {
                	formdata.append('access', self.access());
                
	                if (self.access() == 1) {
	                	formdata.append('users', self.users());
	                }
                }

                ajaxcalls.form(self.samplesURI, 'POST', formdata).done(function(data) {
                	if (!$.isEmptyObject(data)) {
                		data = JSON.parse(data);
                 		workflowId = data.id;
                 		$('#script-name').text(data.name);
                 		editor.session.getUndoManager().markClean();
                 	}
                	
                	samplesViewModel.load();
                });
            }
            
            self.getCodeEditor = function() { return self.sampleEditor; }
        }
        
        function isJson(item) {
            item = typeof item !== "string" ? JSON.stringify(item) : item;

            try {
                item = JSON.parse(item);
            } catch (e) {
                return false;
            }

            return (typeof item === "object" && item !== null);
        }
        
        function AddLibraryViewModel() {
            var self = this;
            self.tasksURI = '/functions';
            
            self.name = ko.observable("{{username}}");
            self.org = ko.observable();
            self.access = ko.observable();
            self.pippkgs = ko.observable();
 			
			self.mapperEditor = CreateAceEditor("#mapper", "ace/mode/json", 200);
			self.codeEditor = CreateAceEditor("#servicescript", "ace/mode/python", 200);
			
			self.checkFunction = function() {
				var formdata = new FormData();
				
				var json = self.mapperEditor.getSession().getValue();
				if (!isJson(json)) {
					$("#add-library-info").text("Not a valid JSON mapper.");
					return false;
				}
				
				var mapper = JSON.parse(json);
				if (!mapper || !mapper.functions || !mapper.functions.length) {
					$("#add-library-info").text("No valid service is defined for mapping in JSON.");
					return false;
				}
				mapper = mapper.functions[0];
				var func = (mapper.name && mapper.name.length ? mapper.name : mapper.internal);
				if (!func || !func.length) {
					$("#add-library-info").text("No valid service name is given.");
					return false;
				}
				
				var package_name = (self.name() && self.name().length ? self.name() : "");
				
				var success = false;
				ajaxcalls.simple(self.tasksURI, 'GET', { 'check_function': '', 'package':  package_name, 'name': func, 'script': self.codeEditor.getSession().getValue(), 'mapper': self.mapperEditor.getSession().getValue()}, false).done(function(data) {
            		
					if (data === undefined) {
						$("#add-library-info").text("Can't retrieve service information. Check your internet connection.");
						return;
					}
					
					success = data['error'] === undefined;
					if (!success) {
						$("#add-library-info").text(data['error']);
					}
				});
				
				return success;
			}
			
            self.addLibrary = function(task) {
            	
            	if (!self.checkFunction()) {            		
            		return;
            	}
            	
            	$("#add-library-info").text("");
            	$('#add').modal('hide');
            	
            	var files = $("#module").get(0).files;
            	var formdata = new FormData();
            	formdata.append('library', files[0]); //use get('files')[0]
            	formdata.append('mapper', self.mapperEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
				formdata.append('script', self.codeEditor.getSession().getValue());//you can append it to formdata with a proper parameter name
            	
            	if (self.name() !== undefined)
            		formdata.append('package', self.name());
            	if (self.org() !== undefined)
            		formdata.append('org', self.org());
            	if (self.access() !== undefined)
            		formdata.append('access', self.access());
            	if (self.pippkgs() !== undefined)
            		formdata.append('pippkgs', self.pippkgs());

                ajaxcalls.form(self.tasksURI, 'POST', formdata).done(function(data) {
                                   	
                    $("#output").val(data.out !== undefined ? data.out : "");
                    $("#error").val(data.err !== undefined ? data.err : "");
                    $("#log tbody").empty();
                    
                    if (tasksViewModel !== undefined) {
                    	tasksViewModel.load();
                    }
                    
                    if (data.err !== undefined && data.err.length != 0) {
                    	printExecStatus("Service cannot be added.");
                    	activateTab(2);
                    }
                    else {
                    	activateTab(1);
                    }
                });
            }
            
            self.getMapperEditor = function() { return self.mapperEditor; }
			self.getCodeEditor = function() { return self.codeEditor; }
        }
        
        function EditTaskViewModel() {
            var self = this;
            self.package_name = ko.observable();
            self.name = ko.observable();
            self.internal = ko.observable();
            self.example = ko.observable();
            self.example2 = ko.observable();
 
            self.setTask = function(task) {
                self.task = task;
                self.package_name(task.package_name());
                self.name(task.name());
                self.internal(task.internal());
                self.example(task.example());
                self.example2(task.example2());
                $('edit').modal('show');
            }
 
            self.editTask = function() {
                $('#edit').modal('hide');
                tasksViewModel.edit(self.task, {
                	package_name: self.package_name(),
                	name: self.name(),
                    internal: self.internal(),
                    example: self.example(),
                    example2: self.example2()
                });
            }
        }
       
       function MetaDataViewModel() {
            var self = this;
            
            self.metadataURI = '/datasources';
            self.filename = new ko.observable();
            self.systemProperties = new ko.observableDictionary();
            self.visualizers = new ko.observableDictionary();
            self.annotations = new ko.observableDictionary(); // list of strings
            self.properties = new ko.observableDictionary(); // keyvalue
            self.mimetypes = new ko.observableDictionary();
           
            self.load = function(path) {

            	self.filename(path.replace(/^.*[\\\/]/, ''));
            	ajaxcalls.simple(self.metadataURI, 'GET', {'path': path}).done(function(data) {
                	if (data == undefined)
                		return;
                	
                	self.systemProperties.removeAll();
                    $.each(data['sysprops'], function(key, value){
                       	self.systemProperties.push(key, value);
                    });
                    
                    self.visualizers.removeAll();
                    $.each(data['visualizers'], function(key, value){
                        self.visualizers.push(key, value);
                    });
                    
                    self.annotations.removeAll();
                    $.each(data['annotations'], function(index, value){
                        self.annotations.push(index.toString(), value);
                    })
                    
                    /* var observableAnnotations = ko.utils.arrayMap(data['annotations'], function(annotation) {
                        return { name: ko.observable(annotation) }; 
                    });
                    self.annotations = ko.observableArray(observableAnnotations); */
                    
                    self.properties.removeAll();
                    $.each(data['properties'], function(key, value){
                        self.properties.push(key, value);
                    });
                    
                    self.mimetypes.removeAll();
                    $.each(data['mimetypes'], function(key, value){
                        self.mimetypes.push(key, value);
                    })
                    
                }).fail(function(jqXHR) {
                    showXHRText(jqXHR);
                }).always(function(x, textStatus, jqXHR){
                	self.historyLoading = false;
                });
            }
        }
        
        function RunnablesViewModel(sampleViewModel) {
            var self = this;
            self.runnablesURI = '/runnables';
            self.items = ko.observableArray();
        	self.historyLoading = false;
        	self.clicks = 0;
            self.timer = null;
            
            self.copyToEditorDblClick = function(itme, event) {
           	 event.preventDefault();
            }
            self.toggleExpand = function(item, event) {
           	 event.stopPropagation();
           	 
           	 self.clicks++;
           	 if (self.clicks !== 1) {
           		 clearTimeout(self.timer);
           		 self.copyToEditor(item);
           		 self.clicks = 0;
   				 return;        		 
           	 }
           	 
           	 self.timer = setTimeout(function(){
           		 self.clicks = 0;
           		 event.preventDefault();
           	 var domItem = $(event.target);
       		 $(".expandedhistory").remove();           	 
           	 if (item.expanded()) {
           		 item.expanded(false);
          	    } else {
          	      self.items().forEach(function(candidateSample) {
          	        candidateSample.expanded(item === candidateSample);
          	        if (item === candidateSample){
          	        	
          	        	$.ajax({
	                        url: "/runnables?tooltip=" + item.id()
	                    })
	                    .then(function(content) {
	                        // Set the tooltip content upon successful retrieval
	                        content = JSON.parse(content);
	                        content = "<div class=\'expandedhistory\' style=\'border:2px solid black;background-color:lightblue\'> <p>Name: " + content.name + "</p><p>Created: " + content.created_on + "<br>Modified: " + content.modified_on + "<br>Duration: " + content.duration + 
	                        	"(s)</p><p>Status: " + content.status + (content.err && content.err.length > 0 ? "<br>Error: " + content.err : "") + "</p><p>Double click to show in report.<br>Check to pin job to report.</p></div>";
	                        	
                        	domItem.parent().append(content);

	                    }, function(xhr, status, error) {
	                        // Upon failure... set the tooltip content to error
	                    });
          	      }
          	    });
          	    }
           	 }, 300);
        	}
            
			self.loadHistory = function(id, switchTab = false) {
            	
				ajaxcalls.simple(self.runnablesURI, 'GET', { 'id':  id}).done(function(data) {
            		
					if (data === undefined)
						return;
	            	
					if (switchTab) {
		            	if (data['err'] && data['status'] !== 'SUCCESS'){
	                    	activateTab(2);
		            	}
	                    else {
	                    	if (!$.isEmptyObject(data['log']))
	                    		activateTab(3);
	                    	else
	                    		activateTab(1);
	                    }
					}
	            	
					$("#output").val(data['out']);
	            	$("#error").val(data['err']);
	            	$("#log tbody").empty();
	            	jsonArray2Table($("#log"), data['log']);
	            	$("#duration").html(data['duration'] + 's');
	            	printExecStatus(data['status']);
            	}).fail(function(jqXHR, textStatus) {
                	$('#refresh').hide();
                	showXHRText(jqXHR);
                });
            }
            
			self.about = function() {
				window.open("static/biodsl-help.html#jobs", '_blank');
		    }
			
            self.copyToEditor = function(item) {
            	reportId = item.id();
            	self.loadHistory(reportId, true);
            }
            
            self.selectedIds = function() {
            	var ids = [];
                var items = self.items();
                for (var i = 0; i < items.length; i++) {
                    if (items[i].selected()){
                        ids.push(items[i].id());
                    }
                }
                return ids;
            }
            
            self.stop = function(){
            	
                ids = self.selectedIds();
                if (ids.length == 0)
                	return;
                
            	ajaxcalls.simple(self.runnablesURI, 'GET', { 'stop':  ids.join()}).done(function(data) {
            		
            	});
            }
            
			self.restart = function(){
            	
                ids = self.selectedIds();
                if (ids.length == 0)
                	return;
                
            	ajaxcalls.simple(self.runnablesURI, 'GET', { 'restart':  ids.join()}).done(function(data) {
            		
            	});
            }
			
			self.changeSelection = function(state){
				$.each(self.items(), function(index, item){
					item.selected(state);
				});
			}
			
			self.selectAll = function(){
            	self.changeSelection(true);
            }
			
			self.deselectAll = function(){
				self.changeSelection(false);
            }
            
            self.statusIcon = function(status){
            	if (status == "STARTED" || status == "PENDING" || status == "RECEIVED")
            		return "{{ url_for('static', filename='spinner.gif') }}";
            	else if (status == "FAILURE")
                	return "{{ url_for('static', filename='cancel.gif') }}";
            	else
            		return "{{ url_for('static', filename='completed.gif') }}";
            }
            
            self.load = function() {
            	if (self.historyLoading)
            		return;
            	
            	self.historyLoading = true;
                ajaxcalls.simple(self.runnablesURI, 'GET').done(function(data) {
                	if (data == undefined)
                		return;
                	
                	var selectedIds = self.selectedIds();
                    self.items([]);
                    $.each(data['runnables'], function(i, s){
                        self.items.push({
                        	id: ko.observable(s.id),
                            name: ko.observable(s.name),
                            modified:ko.observable(s.modified),
                            status: ko.observable(s.status),
                            recent: ko.observable(s.recent !== undefined),
                            statusImg: ko.observable(self.statusIcon(s.status)),
                            selected: ko.observable($.inArray(s.id, selectedIds) !== -1),
                            expanded: ko.observable(false)
                        });
                    });
                }).fail(function(jqXHR) {
                    showXHRText(jqXHR);
                }).always(function(x, textStatus, jqXHR){
                	self.historyLoading = false;
                });
            }
        }
        
        var addLibraryViewModel = new AddLibraryViewModel();
        var sampleViewModel = new SampleViewModel();
        var editTaskViewModel = new EditTaskViewModel();
//         var loginViewModel = new LoginViewModel();
        var tasksViewModel = new TasksViewModel();
        tasksViewModel.load();
        
        var samplesViewModel = new SamplesViewModel(sampleViewModel);
        samplesViewModel.load();
        
        var runnablesViewModel = new RunnablesViewModel();        
        runnablesViewModel.load();
        
        var metadataViewModel = new MetaDataViewModel();
        
        ko.applyBindings(tasksViewModel, $('#main')[0]);
        ko.applyBindings(tasksViewModel, $('#functions')[0]);
        ko.applyBindings(samplesViewModel, $('#samples')[0]);
        ko.applyBindings(addLibraryViewModel, $('#add')[0]);
        ko.applyBindings(sampleViewModel, $('#addSample')[0]);
        ko.applyBindings(editTaskViewModel, $('#edit')[0]);
        ko.applyBindings(metadataViewModel, $('#metadataView')[0]);
        ko.applyBindings(metadataViewModel, $('#update-metadata-dialog')[0]);
                
        ko.applyBindings(runnablesViewModel, $('#runnableWorkflowsPanel')[0]);
    
        dataSourceViewModel.loadMetadataProperties();
        ko.applyBindings(dataSourceViewModel, $("#file-upload-dialog")[0]);

    function D3Graph()
    {
    	var self = this;
   		self.width = 960;
   		self.height = 500;
   		self.colors = d3.scaleOrdinal(d3.schemeCategory10);

		self.show = function(rels) {
			self.nodes = [];
			self.links = [];
			
			rels.forEach(function(rel){
				var exists = self.nodes.filter(function(n)
					{
						return rel.source.id === n.id; 
					});
				if (exists.length == 0)
					self.nodes.push(rel.source);
				
				exists = self.nodes.filter(function(n)
					{
						return rel.target.id === n.id; 
					});
				if (exists.length == 0)
					self.nodes.push(rel.target);
			});
			
			rels.forEach(function(rel) { 
			    var sourceNode = self.nodes.filter(function(n) { return n.id === rel.source.id; })[0];
			    var targetNode = self.nodes.filter(function(n) { return n.id === rel.target.id; })[0];
			    self.links.push({source: sourceNode, target: targetNode, value: rel.type});
			});
			
// 			// Compute the distinct nodes from the links.
// 	   		self.links.forEach(function(link) {
// 	   		  link.source = self.nodes[link.source] || (self.nodes[link.source] = link.source);
// 	   		  link.target = self.nodes[link.target] || (self.nodes[link.target] = link.target);
// 	   		});
			
			self.width = $("#graph").width();
			self.height = $("#graph").height();
			
// 			var force = d3.layout.force()
// 	   		    .nodes(d3.values(self.nodes))
// 	   		    .links(self.links)
// 	   		    .size([self.width, self.height])
// 	   		    .linkDistance(60)
// 	   		    .charge(-300)
// 	   		    .friction(0.9)
// 	   		    .on("tick", self.tick)
// 	   		    .start();
			
			if (self.svg !== undefined && self.svg != null) {
				d3.select("svg")
					.selectAll("*")
					.remove();
				d3.select("svg").remove();
			}
			
			self.svg = d3.select("#graph").append("svg")
   		    	.attr("width", self.width)
   		    	.attr("height", self.height);
			
			self.svg.append('defs').append('marker')
		        .attrs({'id':'arrowhead',
		            'viewBox':'-0 -5 10 10',
		            'refX':13,
		            'refY':0,
		            'orient':'auto',
		            'markerWidth':13,
		            'markerHeight':13,
		            'xoverflow':'visible'})
		        .append('svg:path')
		        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
		        .attr('fill', '#999')
		        .style('stroke','none');
			
			self.simulation = d3.forceSimulation()
		        .force("link", d3.forceLink().id(function (d) {return d.id;}).distance(100).strength(1))
		        .force("charge", d3.forceManyBody())
		        .force("center", d3.forceCenter(self.width / 2, self.height / 2));
			
			self.link = self.svg.selectAll(".link")
            .data(self.links)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr('marker-end','url(#arrowhead)');
				
	        self.link.append("title")
	            .text(function (d) {return d.type;});
        	
			self.edgepaths = self.svg.selectAll(".edgepath")
	            .data(self.links)
	            .enter()
	            .append('path')
	            .attrs({
	                'class': 'edgepath',
	                'fill-opacity': 0,
	                'stroke-opacity': 0,
	                'id': function (d, i) {return 'edgepath' + i}
	            })
            	.style("pointer-events", "none");

        	self.edgelabels = self.svg.selectAll(".edgelabel")
	            .data(self.links)
	            .enter()
	            .append('text')
	            .style("pointer-events", "none")
	            .attrs({
	                'class': 'edgelabel',
	                'id': function (d, i) {return 'edgelabel' + i},
	                'font-size': 10,
	                'fill': '#aaa'
	            });

	        self.edgelabels.append('textPath')
	            .attr('xlink:href', function (d, i) {return '#edgepath' + i})
	            .style("text-anchor", "middle")
	            .style("pointer-events", "none")
	            .attr("startOffset", "50%")
	            .text(function (d) {return d.value});
	        
	       self.node = self.svg.selectAll(".node")
		        .data(self.nodes)
		        .enter()
		        .append("g")
		        .attr("class", "node")
		   	    .on("mouseover", self.mouseover)
			    .on("mouseout", self.mouseout)
		        .call(d3.drag()
		                .on("start", self.dragstarted)
		                .on("drag", self.dragged)
		                //.on("end", self.dragended)
		        );

		    self.node.append("circle")
		        .attr("r", 5)
		        .style("fill", function (d, i) {return self.colors(i);})
		
		    self.node.append("title")
		        .text(function (d) {return d.id;});
		
		    self.node.append("text")
		        .attr("dy", -3)
		        .text(function (d) {return d.name+":"+d.label;});

		    self.simulation
   				.nodes(self.nodes)
            	.on("tick", self.tick);

	        self.simulation.force("link")
	            .links(self.links);
		}
   		
   		self.tick = function() {
   			self.link
            .attr("x1", function (d) {return d.source.x;})
            .attr("y1", function (d) {return d.source.y;})
            .attr("x2", function (d) {return d.target.x;})
            .attr("y2", function (d) {return d.target.y;});

        	self.node.attr("transform", function (d) {return "translate(" + d.x + ", " + d.y + ")";});

	        self.edgepaths.attr('d', function (d) {
	            return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
	        });

	        self.edgelabels.attr('transform', function (d) {
	            if (d.target.x < d.source.x) {
	                /* var bbox = this.getBBox();
	                rx = bbox.x + bbox.width / 2;
	                ry = bbox.y + bbox.height / 2; */
	                rx=0;
	                ry=0;
	                return 'rotate(180 ' + rx + ' ' + ry + ')';
	            }
	            else {
	                return 'rotate(0)';
	            }
	        });
  	  	}

   		self.mouseover = function() {
   		  d3.select(this).select("circle").transition()
   		      .duration(750)
   		      .attr("r", 16);
   		}

   		self.mouseout = function() {
   		  d3.select(this).select("circle").transition()
   		      .duration(750)
   		      .attr("r", 8);
   		}
   		
   		self.dragstarted = function(d) {
   	        if (!d3.event.active)
   	        	self.simulation.alphaTarget(0.3).restart()
   	        d.fx = d.x;
   	        d.fy = d.y;
   	    }

   	    self.dragged = function(d) {
   	        d.fx = d3.event.x;
   	        d.fy = d3.event.y;
   	    }
    }
    
    d3graph = new D3Graph();
    
    $(window).on('unload', function() {
        if (refreshId != 0)
            clearInterval(refreshId);
    });
        
	$(window).on("blur focus", function(e) {
	    var prevType = $(this).data("prevType");
	
	    if (prevType != e.type) {   //  reduce double fire issues
	        switch (e.type) {
	            case "blur":
	            	clearInterval(refreshId);
	            	refreshId = 0;
	                break;
	            case "focus":
	            	if (!refreshId) {
	            		refreshId = setInterval(function() {
	            			if (runnablesViewModel !== undefined)
	            				runnablesViewModel.load();
	            			if (reportId > 0) {
	            				runnablesViewModel.loadHistory(reportId, false);
	            			}
	           				/* ids = runnablesViewModel.selectedIds();
	                        if (ids.length == 1) {
	                        	runnablesViewModel.loadHistory(ids[0], false);
	            			} */
	                    }, 10000); //  refresh the executables once in 10 seconds
	            	}
	                break;
	        }
	    }
	
	    $(this).data("prevType", e.type);
	})
	
	$(window).on('beforeunload', function(){
		var script = $.trim(editor.getSession().getValue());
    	localStorage.setItem(username.concat('_inputVals'), JSON.stringify(script) );
	});
	
	$(window).on('keypress', function(event){
		if(event.keyCode=='27'){
          $("#add").modal('hide');
		  $("#addSample").modal('hide');
      }
	});
	
	// Add row on add button click
	$(document).on("click", ".add", function(){
		var empty = false;
		var input = $(this).parents("tr").find('input[type="text"]');
        input.each(function(){
			if(!$(this).val()){
				$(this).addClass("error");
				empty = true;
			} else{
                $(this).removeClass("error");
            }
		});
		$(this).parents("tr").find(".error").first().focus();
		if(!empty){
			input.each(function(){
				$(this).parent("td").html($(this).val());
			});			
			$(this).parents("tr").find(".add, .edit").toggle();
			$(".add-new").removeAttr("disabled");
		}		
    });
	
	// Edit row on edit button click
	$(document).on("click", ".edit", function(){		
        $(this).parents("tr").find("td:not(:last-child)").each(function(){
			$(this).html('<input type="text" class="form-control" value="' + $(this).text() + '">');
		});		
		$(this).parents("tr").find(".add, .edit").toggle();
		$(".add-new").attr("disabled", "disabled");
    });
	// Delete row on delete button click
	$(document).on("click", ".delete", function(){
        $(this).parents("tr").remove();
		$(".add-new").removeAttr("disabled");
    });
	
	
	$("#exTabBiowl").on("click", "a", function (e) {
        e.preventDefault();

        $(this).tab('show');
        $currentBiowlTab = $(this);
    });
	
	$("#exTabBiowl").on('shown.bs.tab', function (e) {
		var x = $(e.target).text();
		if (x === "Graph") {
			tasksViewModel.buildGraph();
		}
	})

	//this method will register event on close icon on the tab..
    function registerCloseEvent() {

        $(".closeTab").click(function () {

            //there are multiple elements which has .closeTab icon so close the tab whose close icon is clicked
            var tabContentId = $(this).parent().attr("href");
            $(this).parent().parent().remove(); //remove li of tab
            $(tabContentId).remove(); //remove respective tab content
            $('#exTabBiowl a:first').tab('show'); // Select first tab

        });
    }
	
    function showTab(tabId) {
        $('#exTabBiowl a[href="#' + tabId + '"]').tab('show');
    }
    
    //This function will create a new tab here and it will load the url content in tab content div.
    function createNewTabAndLoadUrl(parms, url, loadDivSelector) {

        $("" + loadDivSelector).load(url, function (response, status, xhr) {
            if (status == "error") {
                var msg = "Sorry but there was an error getting details ! ";
                $("" + loadDivSelector).html(msg + xhr.status + " " + xhr.statusText);
                $("" + loadDivSelector).html("Load Ajax Content Here...");
            }
        });
    }

    
  function createNewTab(tabId, tabHeader, style) {
	  
	  $('#exTabBiowl .nav-tabs').append('<li><a href="#' + tabId + '"><button class="close closeTab" type="button" >×</button>' + tabHeader + '</a></li>');
	  $('#exTabBiowl .tab-content').append('<div class="tab-pane '+ style + '" id="' + tabId + '" style="overflow-y: scroll"></div>');
	  	
	  //createNewTabAndLoadUrl("", "./SamplePage.html", "#" + tabId);
	  
	  //$(this).tab('show');
	  showTab(tabId);
	  registerCloseEvent();
// 	  ko.cleanNode($("#metadataView")[0]);
 	  ko.applyBindings(metadataViewModel, $('#metadataView')[0]);
  }
  
  registerCloseEvent();
        
</script>
{{ pagedown.include_pagedown() }}
{% endblock %}
